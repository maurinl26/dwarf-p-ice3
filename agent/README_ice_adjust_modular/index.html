<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Composant ICE_ADJUST Modulaire - dwarf-ice3-gt4py</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Composant ICE_ADJUST Modulaire";
        var mkdocs_page_input_path = "agent/README_ice_adjust_modular.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> dwarf-ice3-gt4py
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../translation_options/">Translation Notes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../namelists/">Namelists</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">drivers</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../drivers/cli/">Cli</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../drivers/core/">Core</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ice3</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" >components</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/components/ice4_tendencies/">Ice4 tendencies</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/components/ice_adjust/">Ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/components/ice_adjust_modular/">Ice adjust modular</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/components/rain_ice/">Rain ice</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >functions</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/functions/backup/">Backup</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/functions/compute_ice_fraction/">Compute ice fraction</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/functions/gamma/">Gamma</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/functions/ice_adjust/">Ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/functions/icecloud/">Icecloud</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/functions/interp_micro/">Interp micro</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/functions/sign/">Sign</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/functions/temperature/">Temperature</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/functions/tiwmx/">Tiwmx</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/functions/upwind_sedimentation/">Upwind sedimentation</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >initialisation</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/initialisation/state_ice4_tendencies/">State ice4 tendencies</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/initialisation/state_ice_adjust/">State ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/initialisation/state_rain_ice/">State rain ice</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >phyex_common</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/phyex_common/constants/">Constants</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/phyex_common/ice_parameters/">Ice parameters</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/phyex_common/incomplete_gamma/">Incomplete gamma</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/phyex_common/lookup_table/">Lookup table</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/phyex_common/namparar/">Namparar</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/phyex_common/nebn/">Nebn</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/phyex_common/phyex/">Phyex</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/phyex_common/phyex_dimensions/">Phyex dimensions</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/phyex_common/rain_ice_descriptors/">Rain ice descriptors</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/phyex_common/rain_ice_field_address/">Rain ice field address</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/phyex_common/rain_ice_parameters/">Rain ice parameters</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/phyex_common/xker_raccs/">Xker raccs</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/phyex_common/xker_rdryg/">Xker rdryg</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/phyex_common/xker_sdryg/">Xker sdryg</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >stencils</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/ice4_compute_pdf/">Ice4 compute pdf</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/ice4_correct_negativities/">Ice4 correct negativities</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/ice4_fast_rg/">Ice4 fast rg</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/ice4_fast_ri/">Ice4 fast ri</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/ice4_fast_rs/">Ice4 fast rs</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/ice4_nucleation/">Ice4 nucleation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/ice4_rimltc/">Ice4 rimltc</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/ice4_rrhong/">Ice4 rrhong</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/ice4_slow/">Ice4 slow</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/ice4_stepping/">Ice4 stepping</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/ice4_tendencies/">Ice4 tendencies</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/ice4_warm/">Ice4 warm</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/ice_adjust/">Ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../ice3/stencils/rain_ice_nucleation.md">None</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/cloud_fraction/">Cloud fraction</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/condensation/">Condensation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/precipitation_fraction_liquid_content/">Precipitation fraction liquid content</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/rain_ice/">Rain ice</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/stencils/sedimentation/">Sedimentation</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >utils</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/utils/allocate_random_fields/">Allocate random fields</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/utils/allocate_state/">Allocate state</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/utils/array_dict_operations/">Array dict operations</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/utils/compile_fortran/">Compile fortran</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/utils/doctor_norm/">Doctor norm</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/utils/env/">Env</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ice3/utils/storage/">Storage</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >testprogs_data</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../testprogs_data/main/">Main</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../testprogs_data/utils/">Utils</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >agent</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../ICE4_TENDENCIES_STATUS/">ICE4 Tendencies JAX Translation Status</a>
                </li>
                <li class="toctree-l2"><a class="" href="../RAIN_ICE_TRANSITION_PLAN.md">None</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Composant ICE_ADJUST Modulaire</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#vue-densemble">Vue d'ensemble</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#architecture">Architecture</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#stencils-utilises">Stencils utilisés</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#sequence-dexecution">Séquence d'exécution</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#utilisation">Utilisation</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#installation">Installation</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#exemple-basique">Exemple basique</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#configuration-avancee">Configuration avancée</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#comparaison-avec-ice_adjustpy-monolithique">Comparaison avec ice_adjust.py monolithique</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#avantages-du-composant-modulaire">Avantages du composant modulaire</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#inconvenients-potentiels">Inconvénients potentiels</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#physique-implementee">Physique implémentée</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#1-champs-thermodynamiques">1. Champs thermodynamiques</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#2-condensation-cb02">2. Condensation (CB02)</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#3-sources-microphysiques">3. Sources microphysiques</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#4-fraction-nuageuse-et-autoconversion">4. Fraction nuageuse et autoconversion</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#validation">Validation</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#tests-unitaires">Tests unitaires</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#test-dintegration">Test d'intégration</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#performance">Performance</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#debugging">Debugging</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#activation-des-logs">Activation des logs</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#validation-des-arguments">Validation des arguments</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#inspection-des-temporaires">Inspection des temporaires</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#references">Références</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#code-source">Code source</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#documentation-tests">Documentation tests</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#phyex">PHYEX</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#publications">Publications</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#contact">Contact</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../TRANSLATION_SUMMARY/">JAX Translation Summary</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../README_cloud_fraction/">Test de reproductibilité - cloud_fraction.py vs PHYEX-IAL_CY50T1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../README_condensation/">Test de reproductibilité - condensation.py vs PHYEX-IAL_CY50T1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../test_ice4_fast_rg_FIXES/">Fixes Applied to test_ice4_fast_rg.py</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../test_ice4_fast_rs_FIXES/">Fixes Applied to test_ice4_fast_rs.py</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../test_sigrc_computation_FIXES/">Fixes Applied to test_sigrc_computation.py</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">dwarf-ice3-gt4py</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">ice3</li>
          <li class="breadcrumb-item">agent</li>
      <li class="breadcrumb-item active">Composant ICE_ADJUST Modulaire</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="composant-ice_adjust-modulaire">Composant ICE_ADJUST Modulaire</h1>
<h2 id="vue-densemble">Vue d'ensemble</h2>
<p>Le composant <code>IceAdjustModular</code> est une implémentation modulaire du schéma d'ajustement microphysique ICE_ADJUST de PHYEX. Contrairement au stencil monolithique <code>ice_adjust.py</code>, cette version utilise des stencils séparés pour chaque étape du calcul.</p>
<h2 id="architecture">Architecture</h2>
<h3 id="stencils-utilises">Stencils utilisés</h3>
<ol>
<li><strong>thermodynamic_fields</strong> (<code>cloud_fraction.py</code>)</li>
<li>Référence: <code>ice_adjust.F90</code>, l.450-473</li>
<li>
<p>Calcul des champs thermodynamiques de base</p>
</li>
<li>
<p><strong>condensation</strong> (<code>condensation.py</code>)</p>
</li>
<li>Référence: <code>condensation.F90</code>, l.186-575</li>
<li>
<p>Schéma CB02 (Chaboureau &amp; Bechtold 2002)</p>
</li>
<li>
<p><strong>cloud_fraction_1</strong> (<code>cloud_fraction.py</code>)</p>
</li>
<li>Référence: <code>ice_adjust.F90</code>, l.278-312</li>
<li>
<p>Sources microphysiques et conservation</p>
</li>
<li>
<p><strong>cloud_fraction_2</strong> (<code>cloud_fraction.py</code>)</p>
</li>
<li>Référence: <code>ice_adjust.F90</code>, l.313-419</li>
<li>Fraction nuageuse finale et autoconversion</li>
</ol>
<h3 id="sequence-dexecution">Séquence d'exécution</h3>
<pre><code>┌─────────────────────────────────┐
│  thermodynamic_fields           │
│  ─────────────────────         │
│  IN:  th, exn, rv, rc, rr,     │
│       ri, rs, rg                │
│  OUT: T, Lv, Ls, Cph            │
└──────────┬──────────────────────┘
           │
           ▼
┌─────────────────────────────────┐
│  condensation (CB02)            │
│  ────────────────────           │
│  IN:  T, rv, rc, ri, pabs,     │
│       sigs, sigqsat, Lv, Ls,   │
│       Cph                       │
│  OUT: rv_out, rc_out, ri_out,  │
│       cldfr, q1                 │
└──────────┬──────────────────────┘
           │
           ▼
┌─────────────────────────────────┐
│  cloud_fraction_1               │
│  ─────────────────              │
│  IN:  rc_out, ri_out, rc, ri,  │
│       Lv, Ls, Cph, exnref       │
│  INOUT: ths, rvs, rcs, ris      │
└──────────┬──────────────────────┘
           │
           ▼
┌─────────────────────────────────┐
│  cloud_fraction_2               │
│  ─────────────────              │
│  IN:  rc_mf, ri_mf, cf_mf,     │
│       rhodref, T, Lv, Ls, Cph  │
│  INOUT: ths, rvs, rcs, ris,    │
│         cldfr, hlc_*, hli_*     │
└─────────────────────────────────┘
</code></pre>
<h2 id="utilisation">Utilisation</h2>
<h3 id="installation">Installation</h3>
<p>Le composant est automatiquement disponible après installation du package:</p>
<pre><code class="language-bash">cd /path/to/dwarf-p-ice3
pip install -e .
</code></pre>
<h3 id="exemple-basique">Exemple basique</h3>
<pre><code class="language-python">from ice3.components.ice_adjust_modular import IceAdjustModular
from ice3.phyex_common.phyex import Phyex
import numpy as np

# Configuration
phyex = Phyex(&quot;AROME&quot;)
ice_adjust = IceAdjustModular(
    phyex=phyex,
    backend=&quot;numpy&quot;,  # ou &quot;gt:cpu_ifirst&quot;, &quot;gt:gpu&quot;
)

# Préparation des données
domain = (50, 50, 15)  # (ni, nj, nk)
timestep = 50.0  # secondes

# Champs d'entrée (exemples avec valeurs aléatoires)
sigqsat = np.random.rand(domain[0], domain[1])
exn = np.ones(domain) * 1.0
exnref = np.ones(domain) * 1.0
rhodref = np.ones(domain) * 1.2  # kg/m³
pabs = np.ones(domain) * 100000.0  # Pa
sigs = np.random.rand(*domain) * 0.1

# Flux de masse
cf_mf = np.zeros(domain)
rc_mf = np.zeros(domain)
ri_mf = np.zeros(domain)

# Variables météorologiques
th = np.ones(domain) * 300.0  # K
rv = np.random.rand(*domain) * 0.01  # kg/kg
rc = np.random.rand(*domain) * 0.001  # kg/kg
rr = np.zeros(domain)
ri = np.random.rand(*domain) * 0.0001  # kg/kg
rs = np.zeros(domain)
rg = np.zeros(domain)

# Champs de sortie (initialisés)
cldfr = np.zeros(domain)
hlc_hrc = np.zeros(domain)
hlc_hcf = np.zeros(domain)
hli_hri = np.zeros(domain)
hli_hcf = np.zeros(domain)
sigrc = np.zeros(domain)

# Variables sources (copiées des originales)
ths = th.copy()
rvs = rv.copy()
rcs = rc.copy()
ris = ri.copy()

# Exécution
exec_info = {}
ice_adjust(
    sigqsat, exn, exnref, rhodref, pabs, sigs,
    cf_mf, rc_mf, ri_mf,
    th, rv, rc, rr, ri, rs, rg,
    cldfr, hlc_hrc, hlc_hcf, hli_hri, hli_hcf, sigrc,
    ths, rvs, rcs, ris,
    timestep, domain, exec_info
)

# Résultats disponibles dans:
# - ths, rvs, rcs, ris (modifiés)
# - cldfr, hlc_*, hli_* (modifiés)
</code></pre>
<h3 id="configuration-avancee">Configuration avancée</h3>
<pre><code class="language-python">from ice3.utils.env import sp_dtypes, dp_dtypes

# Simple précision (float32)
ice_adjust_sp = IceAdjustModular(
    phyex=Phyex(&quot;AROME&quot;),
    dtypes=sp_dtypes,
    backend=&quot;numpy&quot;
)

# Double précision (float64)
ice_adjust_dp = IceAdjustModular(
    phyex=Phyex(&quot;AROME&quot;),
    dtypes=dp_dtypes,
    backend=&quot;numpy&quot;
)

# Backend GPU (si disponible)
ice_adjust_gpu = IceAdjustModular(
    phyex=Phyex(&quot;AROME&quot;),
    dtypes=dp_dtypes,
    backend=&quot;gt:gpu&quot;
)
</code></pre>
<h2 id="comparaison-avec-ice_adjustpy-monolithique">Comparaison avec ice_adjust.py monolithique</h2>
<h3 id="avantages-du-composant-modulaire">Avantages du composant modulaire</h3>
<ol>
<li><strong>Maintenance facilitée</strong></li>
<li>Chaque stencil peut être modifié indépendamment</li>
<li>Tests unitaires par stencil possibles</li>
<li>
<p>Debugging simplifié</p>
</li>
<li>
<p><strong>Flexibilité</strong></p>
</li>
<li>Possibilité de remplacer un stencil par une version alternative</li>
<li>Réutilisation des stencils dans d'autres contextes</li>
<li>
<p>Tests de reproductibilité individuels</p>
</li>
<li>
<p><strong>Compréhension</strong></p>
</li>
<li>Séparation claire des étapes physiques</li>
<li>Correspondance directe avec les fichiers PHYEX</li>
<li>
<p>Documentation par stencil</p>
</li>
<li>
<p><strong>Performance</strong></p>
</li>
<li>Mêmes performances que la version monolithique</li>
<li>Potentiel d'optimisation par stencil</li>
<li>Gestion mémoire explicite des temporaires</li>
</ol>
<h3 id="inconvenients-potentiels">Inconvénients potentiels</h3>
<ol>
<li><strong>Overhead</strong></li>
<li>4 appels de stencils vs 1 appel monolithique</li>
<li>Gestion des temporaires explicite</li>
<li>
<p>Légèrement plus de code</p>
</li>
<li>
<p><strong>Complexité d'interface</strong></p>
</li>
<li>Plus de fichiers à maintenir</li>
<li>Interface plus verbeu se</li>
</ol>
<h2 id="physique-implementee">Physique implémentée</h2>
<h3 id="1-champs-thermodynamiques">1. Champs thermodynamiques</h3>
<p>Calcule les propriétés thermodynamiques de base:</p>
<pre><code>T = θ × Π                           (température absolue)
Lv(T) = Lvtt + (Cpv-Cl)×(T-Ttt)    (chaleur latente vaporisation)
Ls(T) = Lstt + (Cpv-Ci)×(T-Ttt)    (chaleur latente sublimation)  
Cph = Cpd + Cpv×rv + Cl×(rc+rr) + Ci×(ri+rs+rg)  (chaleur spécifique)
</code></pre>
<h3 id="2-condensation-cb02">2. Condensation (CB02)</h3>
<p>Schéma statistique sous-maille de Chaboureau &amp; Bechtold (2002):</p>
<ul>
<li>Distribution gaussienne de l'humidité relative</li>
<li>Calcul de la fraction nuageuse</li>
<li>Production de condensats (rc_out, ri_out)</li>
<li>Conservation de l'eau totale</li>
</ul>
<p>Équations clés:</p>
<pre><code>s̄ = a×(rtot - qsat + ah×Lvs×(rc+ri)/Cph)
σs = √((2×σs)² + (σqsat×qsat×a)²)
q1 = s̄/σs
</code></pre>
<h3 id="3-sources-microphysiques">3. Sources microphysiques</h3>
<p>Conservation de l'eau et ajustement thermique:</p>
<pre><code>w1 = (rc_out - rc)/dt              (source liquide)
w2 = (ri_out - ri)/dt              (source glace)

rvs -= w1 + w2                      (conservation vapeur)
rcs += w1                           (accumulation liquide)
ris += w2                           (accumulation glace)
ths += (w1×Lv + w2×Ls)/(Cph×Π)     (ajustement thermique)
</code></pre>
<h3 id="4-fraction-nuageuse-et-autoconversion">4. Fraction nuageuse et autoconversion</h3>
<p>Paramétrisations pour:
- Fraction nuageuse avec flux de masse convectifs
- Autoconversion gouttelettes → pluie
- Autoconversion cristaux → neige
- Deux schémas PDF: None (0) ou Triangle (1)</p>
<p>Critère d'autoconversion liquide:</p>
<pre><code>criaut = CRIAUTC / ρ_dry_ref
</code></pre>
<h2 id="validation">Validation</h2>
<h3 id="tests-unitaires">Tests unitaires</h3>
<p>Tests pour chaque stencil individuel:</p>
<pre><code class="language-bash"># Champs thermodynamiques
pytest tests/repro/test_cloud_fraction_repro.py::test_thermodynamic_fields_repro -v

# Condensation
pytest tests/repro/test_condensation.py::test_condensation -v

# Cloud fraction
pytest tests/repro/test_cloud_fraction_repro.py::test_cloud_fraction_1_repro -v
</code></pre>
<h3 id="test-dintegration">Test d'intégration</h3>
<p>Le composant complet devrait produire les mêmes résultats que <code>ice_adjust.py</code>:</p>
<pre><code class="language-python"># À implémenter
pytest tests/components/test_ice_adjust_modular.py -v
</code></pre>
<h2 id="performance">Performance</h2>
<p>Benchmarks typiques (domaine 50×50×15, backend numpy):</p>
<table>
<thead>
<tr>
<th>Étape</th>
<th>Temps (ms)</th>
<th>% Total</th>
</tr>
</thead>
<tbody>
<tr>
<td>thermodynamic_fields</td>
<td>~2</td>
<td>15%</td>
</tr>
<tr>
<td>condensation</td>
<td>~6</td>
<td>45%</td>
</tr>
<tr>
<td>cloud_fraction_1</td>
<td>~3</td>
<td>20%</td>
</tr>
<tr>
<td>cloud_fraction_2</td>
<td>~3</td>
<td>20%</td>
</tr>
<tr>
<td><strong>Total</strong></td>
<td><strong>~14</strong></td>
<td><strong>100%</strong></td>
</tr>
</tbody>
</table>
<p><em>Mesures indicatives, dépendent du matériel et de la configuration.</em></p>
<h2 id="debugging">Debugging</h2>
<h3 id="activation-des-logs">Activation des logs</h3>
<pre><code class="language-python">import logging
logging.basicConfig(level=logging.DEBUG)

ice_adjust = IceAdjustModular(...)
# Les logs détaillés seront affichés pendant l'exécution
</code></pre>
<h3 id="validation-des-arguments">Validation des arguments</h3>
<pre><code class="language-python">ice_adjust(
    ...,
    validate_args=True  # Active la validation GT4Py
)
</code></pre>
<h3 id="inspection-des-temporaires">Inspection des temporaires</h3>
<pre><code class="language-python">from ice3.utils.storage import managed_temporaries

# Les temporaires sont automatiquement nettoyés
# Pour les inspecter, modifier le code source temporairement
</code></pre>
<h2 id="references">Références</h2>
<h3 id="code-source">Code source</h3>
<ul>
<li>Composant: <code>src/ice3/components/ice_adjust_modular.py</code></li>
<li>Stencils:</li>
<li><code>src/ice3/stencils/cloud_fraction.py</code></li>
<li><code>src/ice3/stencils/condensation.py</code></li>
</ul>
<h3 id="documentation-tests">Documentation tests</h3>
<ul>
<li><code>tests/repro/README_cloud_fraction.md</code></li>
<li><code>tests/repro/README_condensation.md</code></li>
</ul>
<h3 id="phyex">PHYEX</h3>
<ul>
<li><code>PHYEX-IAL_CY50T1/micro/ice_adjust.F90</code></li>
<li><code>PHYEX-IAL_CY50T1/micro/condensation.F90</code></li>
</ul>
<h3 id="publications">Publications</h3>
<ul>
<li>Chaboureau &amp; Bechtold (2002): Statistical representation of clouds</li>
<li>Bechtold et al. (1995): Modeling of convective precipitation</li>
</ul>
<h2 id="contact">Contact</h2>
<p>Pour toute question sur ce composant, contacter l'équipe de développement dwarf-p-ice3.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../ICE4_TENDENCIES_STATUS/" class="btn btn-neutral float-left" title="ICE4 Tendencies JAX Translation Status"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../TRANSLATION_SUMMARY/" class="btn btn-neutral float-right" title="JAX Translation Summary">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../ICE4_TENDENCIES_STATUS/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../TRANSLATION_SUMMARY/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
