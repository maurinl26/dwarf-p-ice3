<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Upwind sedimentation - dwarf-ice3-gt4py</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Upwind sedimentation";
        var mkdocs_page_input_path = "ice3/functions/upwind_sedimentation.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> dwarf-ice3-gt4py
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../translation_options/">Translation Notes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../namelists/">Namelists</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">drivers</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../drivers/cli/">Cli</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../drivers/core/">Core</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ice3</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" >components</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../components/ice4_tendencies/">Ice4 tendencies</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../components/ice_adjust/">Ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../components/ice_adjust_modular/">Ice adjust modular</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../components/rain_ice/">Rain ice</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >functions</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../backup/">Backup</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../compute_ice_fraction/">Compute ice fraction</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../gamma/">Gamma</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice_adjust/">Ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../icecloud/">Icecloud</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interp_micro/">Interp micro</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../sign/">Sign</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../temperature/">Temperature</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../tiwmx/">Tiwmx</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Upwind sedimentation</a>
    <ul class="current">
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >initialisation</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../initialisation/state_ice4_tendencies/">State ice4 tendencies</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../initialisation/state_ice_adjust/">State ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../initialisation/state_rain_ice/">State rain ice</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >phyex_common</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/constants/">Constants</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/ice_parameters/">Ice parameters</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/incomplete_gamma/">Incomplete gamma</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/lookup_table/">Lookup table</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/namparar/">Namparar</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/nebn/">Nebn</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/phyex/">Phyex</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/phyex_dimensions/">Phyex dimensions</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/rain_ice_descriptors/">Rain ice descriptors</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/rain_ice_field_address/">Rain ice field address</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/rain_ice_parameters/">Rain ice parameters</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/xker_raccs/">Xker raccs</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/xker_rdryg/">Xker rdryg</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/xker_sdryg/">Xker sdryg</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >stencils</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_compute_pdf/">Ice4 compute pdf</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_correct_negativities/">Ice4 correct negativities</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_fast_rg/">Ice4 fast rg</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_fast_ri/">Ice4 fast ri</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_fast_rs/">Ice4 fast rs</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_nucleation/">Ice4 nucleation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_rimltc/">Ice4 rimltc</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_rrhong/">Ice4 rrhong</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_slow/">Ice4 slow</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_stepping/">Ice4 stepping</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_tendencies/">Ice4 tendencies</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_warm/">Ice4 warm</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice_adjust/">Ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../stencils/rain_ice_nucleation.md">None</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/cloud_fraction/">Cloud fraction</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/condensation/">Condensation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/precipitation_fraction_liquid_content/">Precipitation fraction liquid content</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/rain_ice/">Rain ice</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/sedimentation/">Sedimentation</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >utils</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/allocate_random_fields/">Allocate random fields</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/allocate_state/">Allocate state</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/array_dict_operations/">Array dict operations</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/compile_fortran/">Compile fortran</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/doctor_norm/">Doctor norm</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/env/">Env</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/storage/">Storage</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >testprogs_data</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../testprogs_data/main/">Main</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../testprogs_data/utils/">Utils</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >agent</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/ICE4_TENDENCIES_STATUS/">ICE4 Tendencies JAX Translation Status</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../../agent/RAIN_ICE_TRANSITION_PLAN.md">None</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/README_ice_adjust_modular/">Composant ICE_ADJUST Modulaire</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/TRANSLATION_SUMMARY/">JAX Translation Summary</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/README_cloud_fraction/">Test de reproductibilité - cloud_fraction.py vs PHYEX-IAL_CY50T1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/README_condensation/">Test de reproductibilité - condensation.py vs PHYEX-IAL_CY50T1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/test_ice4_fast_rg_FIXES/">Fixes Applied to test_ice4_fast_rg.py</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/test_ice4_fast_rs_FIXES/">Fixes Applied to test_ice4_fast_rs.py</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/test_sigrc_computation_FIXES/">Fixes Applied to test_sigrc_computation.py</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">dwarf-ice3-gt4py</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">ice3</li>
          <li class="breadcrumb-item">functions</li>
      <li class="breadcrumb-item active">Upwind sedimentation</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <div class="doc doc-object doc-module">



<a id="ice3.functions.upwind_sedimentation"></a>
    <div class="doc doc-contents first">

        <p>Upwind sedimentation scheme functions for microphysics.</p>
<p>This module provides GT4Py implementations of functions used in the
upwind sedimentation scheme for hydrometeor species. The scheme handles
vertical transport of precipitation particles with adaptive time stepping
to maintain numerical stability.</p>










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ice3.functions.upwind_sedimentation.instant_precipitation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">instant_precipitation</span><span class="p">(</span><span class="n">wsed</span><span class="p">,</span> <span class="n">max_tstep</span><span class="p">,</span> <span class="n">TSTEP</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calculate instantaneous precipitation rate at the surface.</p>
<p>This function converts the sedimentation flux at the ground into
a precipitation rate in standard units (mm/s or mm/h).</p>
<h4 id="ice3.functions.upwind_sedimentation.instant_precipitation--parameters">Parameters</h4>
<p>wsed : Field[float]
    Sedimentation flux at the ground level (kg/(m²·s)).
max_tstep : Field[float]
    Time step used for the sedimentation calculation (s).
TSTEP : float
    Full model time step (s).</p>
<h4 id="ice3.functions.upwind_sedimentation.instant_precipitation--returns">Returns</h4>
<p>Field[float]
    Instantaneous precipitation rate (mm/s), assuming the flux
    represents liquid water equivalent.</p>
<h4 id="ice3.functions.upwind_sedimentation.instant_precipitation--notes">Notes</h4>
<p>The conversion uses RHOLW (density of liquid water, typically
1000 kg/m³) as an external constant.</p>
<p>The formula is:
precip = (flux / ρ_water) * (max_tstep / TSTEP)</p>
<p>This gives precipitation in m/s, which equals mm/s when
considering the density conversion.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/ice3/functions/upwind_sedimentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">instant_precipitation</span><span class="p">(</span>
    <span class="n">wsed</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span> <span class="n">max_tstep</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span> <span class="n">TSTEP</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate instantaneous precipitation rate at the surface.</span>

<span class="sd">    This function converts the sedimentation flux at the ground into</span>
<span class="sd">    a precipitation rate in standard units (mm/s or mm/h).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wsed : Field[float]</span>
<span class="sd">        Sedimentation flux at the ground level (kg/(m²·s)).</span>
<span class="sd">    max_tstep : Field[float]</span>
<span class="sd">        Time step used for the sedimentation calculation (s).</span>
<span class="sd">    TSTEP : float</span>
<span class="sd">        Full model time step (s).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Field[float]</span>
<span class="sd">        Instantaneous precipitation rate (mm/s), assuming the flux</span>
<span class="sd">        represents liquid water equivalent.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The conversion uses RHOLW (density of liquid water, typically</span>
<span class="sd">    1000 kg/m³) as an external constant.</span>

<span class="sd">    The formula is:</span>
<span class="sd">    precip = (flux / ρ_water) * (max_tstep / TSTEP)</span>

<span class="sd">    This gives precipitation in m/s, which equals mm/s when</span>
<span class="sd">    considering the density conversion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">__externals__</span><span class="w"> </span><span class="kn">import</span> <span class="n">RHOLW</span>

    <span class="k">return</span> <span class="n">wsed</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">RHOLW</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_tstep</span> <span class="o">/</span> <span class="n">TSTEP</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ice3.functions.upwind_sedimentation.maximum_time_step" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">maximum_time_step</span><span class="p">(</span><span class="n">rtmin</span><span class="p">,</span> <span class="n">rhodref</span><span class="p">,</span> <span class="n">max_tstep</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">wsed</span><span class="p">,</span> <span class="n">remaining_time</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Compute maximum stable time step for sedimentation scheme.</p>
<p>This function determines the maximum time step that satisfies the
CFL (Courant-Friedrichs-Lewy) stability condition for the upwind
sedimentation scheme.</p>
<h4 id="ice3.functions.upwind_sedimentation.maximum_time_step--parameters">Parameters</h4>
<p>rtmin : float
    Minimum mixing ratio threshold below which sedimentation is ignored (kg/kg).
rhodref : Field[float]
    Reference air density (kg/m³).
max_tstep : Field[IJ, float]
    Current maximum time step (s), updated if smaller step is needed.
r : Field[float]
    Mixing ratio of the sedimenting species (kg/kg).
dz : Field[float]
    Layer thickness (m).
wsed : Field[float]
    Sedimentation flux (kg/(m²·s)).
remaining_time : Field[IJ, float]
    Time remaining in the full time step (s).</p>
<h4 id="ice3.functions.upwind_sedimentation.maximum_time_step--returns">Returns</h4>
<p>Field[float]
    Updated maximum stable time step (s).</p>
<h4 id="ice3.functions.upwind_sedimentation.maximum_time_step--notes">Notes</h4>
<p>The CFL condition for stability is:
Δt ≤ SPLIT_MAXCFL * (ρ · r · Δz) / flux</p>
<p>where SPLIT_MAXCFL is an external safety factor (typically &lt; 1).</p>
<p>The time step is only computed when:
- r &gt; rtmin (sufficient mass present)
- wsed &gt; 1e-20 (non-negligible flux)
- remaining_time &gt; 0 (time remains in step)</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/ice3/functions/upwind_sedimentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">maximum_time_step</span><span class="p">(</span>
    <span class="n">rtmin</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
    <span class="n">rhodref</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">max_tstep</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="n">IJ</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">r</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">dz</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">wsed</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">remaining_time</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="n">IJ</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute maximum stable time step for sedimentation scheme.</span>

<span class="sd">    This function determines the maximum time step that satisfies the</span>
<span class="sd">    CFL (Courant-Friedrichs-Lewy) stability condition for the upwind</span>
<span class="sd">    sedimentation scheme.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rtmin : float</span>
<span class="sd">        Minimum mixing ratio threshold below which sedimentation is ignored (kg/kg).</span>
<span class="sd">    rhodref : Field[float]</span>
<span class="sd">        Reference air density (kg/m³).</span>
<span class="sd">    max_tstep : Field[IJ, float]</span>
<span class="sd">        Current maximum time step (s), updated if smaller step is needed.</span>
<span class="sd">    r : Field[float]</span>
<span class="sd">        Mixing ratio of the sedimenting species (kg/kg).</span>
<span class="sd">    dz : Field[float]</span>
<span class="sd">        Layer thickness (m).</span>
<span class="sd">    wsed : Field[float]</span>
<span class="sd">        Sedimentation flux (kg/(m²·s)).</span>
<span class="sd">    remaining_time : Field[IJ, float]</span>
<span class="sd">        Time remaining in the full time step (s).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Field[float]</span>
<span class="sd">        Updated maximum stable time step (s).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The CFL condition for stability is:</span>
<span class="sd">    Δt ≤ SPLIT_MAXCFL * (ρ · r · Δz) / flux</span>

<span class="sd">    where SPLIT_MAXCFL is an external safety factor (typically &lt; 1).</span>

<span class="sd">    The time step is only computed when:</span>
<span class="sd">    - r &gt; rtmin (sufficient mass present)</span>
<span class="sd">    - wsed &gt; 1e-20 (non-negligible flux)</span>
<span class="sd">    - remaining_time &gt; 0 (time remains in step)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">__externals__</span><span class="w"> </span><span class="kn">import</span> <span class="n">SPLIT_MAXCFL</span>

    <span class="n">tstep</span> <span class="o">=</span> <span class="n">max_tstep</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">rtmin</span> <span class="ow">and</span> <span class="n">wsed</span> <span class="o">&gt;</span> <span class="mf">1e-20</span> <span class="ow">and</span> <span class="n">remaining_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">tstep</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="n">max_tstep</span><span class="p">,</span>
            <span class="n">SPLIT_MAXCFL</span> <span class="o">*</span> <span class="n">rhodref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">wsed</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">tstep</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ice3.functions.upwind_sedimentation.mixing_ratio_update" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mixing_ratio_update</span><span class="p">(</span><span class="n">max_tstep</span><span class="p">,</span> <span class="n">oorhodz</span><span class="p">,</span> <span class="n">wsed</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">r_t</span><span class="p">,</span> <span class="n">TSTEP</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Update mixing ratio due to sedimentation flux divergence.</p>
<p>This function applies the upwind scheme to update the mixing ratio
based on the vertical flux divergence and local tendencies.</p>
<h4 id="ice3.functions.upwind_sedimentation.mixing_ratio_update--parameters">Parameters</h4>
<p>max_tstep : Field[IJ, float]
    Maximum stable time step for the current iteration (s).
oorhodz : Field[float]
    Inverse of (air density * layer thickness), 1/(ρ·Δz) (m/kg).
wsed : Field[float]
    Sedimentation flux at cell interfaces (kg/(m²·s)).
rs : Field[float]
    Source/sink tendency for mixing ratio (kg/kg/s).
r_t : Field[float]
    Current mixing ratio at time t (kg/kg).
TSTEP : float
    Full model time step (s).</p>
<h4 id="ice3.functions.upwind_sedimentation.mixing_ratio_update--returns">Returns</h4>
<p>Field[float]
    Updated tendency rs including sedimentation effects (kg/kg/s).</p>
<h4 id="ice3.functions.upwind_sedimentation.mixing_ratio_update--notes">Notes</h4>
<p>The mixing ratio change is computed from the flux divergence:
Δr = Δt · (1/ρΔz) · (flux_in - flux_out)</p>
<p>Both r_t and rs are updated in place:
- r_t accumulates the instantaneous change
- rs accumulates the tendency normalized by TSTEP</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/ice3/functions/upwind_sedimentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mixing_ratio_update</span><span class="p">(</span>
    <span class="n">max_tstep</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="n">IJ</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">oorhodz</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">wsed</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">rs</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">r_t</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">TSTEP</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update mixing ratio due to sedimentation flux divergence.</span>

<span class="sd">    This function applies the upwind scheme to update the mixing ratio</span>
<span class="sd">    based on the vertical flux divergence and local tendencies.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    max_tstep : Field[IJ, float]</span>
<span class="sd">        Maximum stable time step for the current iteration (s).</span>
<span class="sd">    oorhodz : Field[float]</span>
<span class="sd">        Inverse of (air density * layer thickness), 1/(ρ·Δz) (m/kg).</span>
<span class="sd">    wsed : Field[float]</span>
<span class="sd">        Sedimentation flux at cell interfaces (kg/(m²·s)).</span>
<span class="sd">    rs : Field[float]</span>
<span class="sd">        Source/sink tendency for mixing ratio (kg/kg/s).</span>
<span class="sd">    r_t : Field[float]</span>
<span class="sd">        Current mixing ratio at time t (kg/kg).</span>
<span class="sd">    TSTEP : float</span>
<span class="sd">        Full model time step (s).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Field[float]</span>
<span class="sd">        Updated tendency rs including sedimentation effects (kg/kg/s).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The mixing ratio change is computed from the flux divergence:</span>
<span class="sd">    Δr = Δt · (1/ρΔz) · (flux_in - flux_out)</span>

<span class="sd">    Both r_t and rs are updated in place:</span>
<span class="sd">    - r_t accumulates the instantaneous change</span>
<span class="sd">    - rs accumulates the tendency normalized by TSTEP</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mrchange</span> <span class="o">=</span> <span class="n">max_tstep</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">oorhodz</span> <span class="o">*</span> <span class="p">(</span><span class="n">wsed</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">wsed</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">r_t</span> <span class="o">+=</span> <span class="n">mrchange</span> <span class="o">+</span> <span class="n">rs</span> <span class="o">*</span> <span class="n">max_tstep</span>
    <span class="n">rs</span> <span class="o">+=</span> <span class="n">mrchange</span> <span class="o">/</span> <span class="n">TSTEP</span>

    <span class="k">return</span> <span class="n">rs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ice3.functions.upwind_sedimentation.upper_air_flux" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">upper_air_flux</span><span class="p">(</span><span class="n">wsed</span><span class="p">,</span> <span class="n">max_tstep</span><span class="p">,</span> <span class="n">TSTEP</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calculate the upward sedimentation flux at the upper boundary.</p>
<p>This function computes the sedimentation flux entering from above
based on the sedimentation velocity and the adaptive time step ratio.</p>
<h4 id="ice3.functions.upwind_sedimentation.upper_air_flux--parameters">Parameters</h4>
<p>wsed : Field[float]
    Sedimentation velocity field (m/s), positive downward.
max_tstep : Field[IJ, float]
    Maximum stable time step for the current iteration (s).
TSTEP : float
    Full model time step (s).</p>
<h4 id="ice3.functions.upwind_sedimentation.upper_air_flux--returns">Returns</h4>
<p>Field[float]
    Upward flux at the upper boundary, normalized by the time step ratio.</p>
<h4 id="ice3.functions.upwind_sedimentation.upper_air_flux--notes">Notes</h4>
<p>The flux is scaled by the ratio max_tstep/TSTEP to account for
sub-stepping when the CFL condition requires smaller time steps.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/ice3/functions/upwind_sedimentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">upper_air_flux</span><span class="p">(</span>
    <span class="n">wsed</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">max_tstep</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="n">IJ</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">TSTEP</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the upward sedimentation flux at the upper boundary.</span>

<span class="sd">    This function computes the sedimentation flux entering from above</span>
<span class="sd">    based on the sedimentation velocity and the adaptive time step ratio.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wsed : Field[float]</span>
<span class="sd">        Sedimentation velocity field (m/s), positive downward.</span>
<span class="sd">    max_tstep : Field[IJ, float]</span>
<span class="sd">        Maximum stable time step for the current iteration (s).</span>
<span class="sd">    TSTEP : float</span>
<span class="sd">        Full model time step (s).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Field[float]</span>
<span class="sd">        Upward flux at the upper boundary, normalized by the time step ratio.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The flux is scaled by the ratio max_tstep/TSTEP to account for</span>
<span class="sd">    sub-stepping when the CFL condition requires smaller time steps.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">wsed</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_tstep</span> <span class="o">/</span> <span class="n">TSTEP</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../tiwmx/" class="btn btn-neutral float-left" title="Tiwmx"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../initialisation/state_ice4_tendencies/" class="btn btn-neutral float-right" title="State ice4 tendencies">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../tiwmx/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../initialisation/state_ice4_tendencies/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
