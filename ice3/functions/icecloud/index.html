<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Icecloud - dwarf-ice3-gt4py</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Icecloud";
        var mkdocs_page_input_path = "ice3/functions/icecloud.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> dwarf-ice3-gt4py
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../translation_options/">Translation Notes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../namelists/">Namelists</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">drivers</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../drivers/cli/">Cli</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../drivers/core/">Core</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ice3</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" >components</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../components/ice4_tendencies/">Ice4 tendencies</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../components/ice_adjust/">Ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../components/ice_adjust_modular/">Ice adjust modular</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../components/rain_ice/">Rain ice</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >functions</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../backup/">Backup</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../compute_ice_fraction/">Compute ice fraction</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../gamma/">Gamma</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice_adjust/">Ice adjust</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Icecloud</a>
    <ul class="current">
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interp_micro/">Interp micro</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../sign/">Sign</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../temperature/">Temperature</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../tiwmx/">Tiwmx</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../upwind_sedimentation/">Upwind sedimentation</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >initialisation</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../initialisation/state_ice4_tendencies/">State ice4 tendencies</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../initialisation/state_ice_adjust/">State ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../initialisation/state_rain_ice/">State rain ice</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >phyex_common</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/constants/">Constants</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/ice_parameters/">Ice parameters</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/incomplete_gamma/">Incomplete gamma</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/lookup_table/">Lookup table</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/namparar/">Namparar</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/nebn/">Nebn</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/phyex/">Phyex</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/phyex_dimensions/">Phyex dimensions</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/rain_ice_descriptors/">Rain ice descriptors</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/rain_ice_field_address/">Rain ice field address</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/rain_ice_parameters/">Rain ice parameters</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/xker_raccs/">Xker raccs</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/xker_rdryg/">Xker rdryg</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/xker_sdryg/">Xker sdryg</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >stencils</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_compute_pdf/">Ice4 compute pdf</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_correct_negativities/">Ice4 correct negativities</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_fast_rg/">Ice4 fast rg</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_fast_ri/">Ice4 fast ri</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_fast_rs/">Ice4 fast rs</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_nucleation/">Ice4 nucleation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_rimltc/">Ice4 rimltc</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_rrhong/">Ice4 rrhong</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_slow/">Ice4 slow</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_stepping/">Ice4 stepping</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_tendencies/">Ice4 tendencies</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice4_warm/">Ice4 warm</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/ice_adjust/">Ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../stencils/rain_ice_nucleation.md">None</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/cloud_fraction/">Cloud fraction</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/condensation/">Condensation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/precipitation_fraction_liquid_content/">Precipitation fraction liquid content</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/rain_ice/">Rain ice</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stencils/sedimentation/">Sedimentation</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >utils</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/allocate_random_fields/">Allocate random fields</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/allocate_state/">Allocate state</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/array_dict_operations/">Array dict operations</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/compile_fortran/">Compile fortran</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/doctor_norm/">Doctor norm</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/env/">Env</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/storage/">Storage</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >testprogs_data</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../testprogs_data/main/">Main</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../testprogs_data/utils/">Utils</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >agent</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/ICE4_TENDENCIES_STATUS/">ICE4 Tendencies JAX Translation Status</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../../agent/RAIN_ICE_TRANSITION_PLAN.md">None</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/README_ice_adjust_modular/">Composant ICE_ADJUST Modulaire</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/TRANSLATION_SUMMARY/">JAX Translation Summary</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/README_cloud_fraction/">Test de reproductibilité - cloud_fraction.py vs PHYEX-IAL_CY50T1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/README_condensation/">Test de reproductibilité - condensation.py vs PHYEX-IAL_CY50T1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/test_ice4_fast_rg_FIXES/">Fixes Applied to test_ice4_fast_rg.py</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/test_ice4_fast_rs_FIXES/">Fixes Applied to test_ice4_fast_rs.py</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/test_sigrc_computation_FIXES/">Fixes Applied to test_sigrc_computation.py</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">dwarf-ice3-gt4py</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">ice3</li>
          <li class="breadcrumb-item">functions</li>
      <li class="breadcrumb-item active">Icecloud</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <div class="doc doc-object doc-module">



<a id="ice3.functions.icecloud"></a>
    <div class="doc doc-contents first">

        <p>Subgrid-scale ice supersaturation calculations.</p>
<p>This module provides GT4Py implementations for computing subgrid-scale
fractions of supersaturation with respect to ice in clouds. This accounts
for spatial variability of relative humidity within a grid cell that is
not resolved by the model's horizontal and vertical resolution.</p>










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ice3.functions.icecloud.icecloud" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">icecloud</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">pblh</span><span class="p">,</span> <span class="n">wcld</span><span class="p">,</span> <span class="n">w2d</span><span class="p">,</span> <span class="n">sifrc</span><span class="p">,</span> <span class="n">ssio</span><span class="p">,</span> <span class="n">ssiu</span><span class="p">,</span> <span class="n">w2d_out</span><span class="p">,</span> <span class="n">rsi</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calculate subgrid-scale supersaturation fraction with respect to ice.</p>
<p>This function computes the fraction of a grid cell that is
supersaturated with respect to ice, accounting for subgrid-scale
variability in relative humidity. It assumes a linear distribution
of relative humidity within the grid cell, with variability that
depends on model level thickness and boundary layer characteristics.</p>
<h4 id="ice3.functions.icecloud.icecloud--parameters">Parameters</h4>
<p>p : Field[IJ, float]
    Pressure at model level (Pa).
z : Field[IJ, float]
    Model level height above ground (m).
dz : Field[IJ, float]
    Model level thickness (m).
t : Field[IJ, float]
    Temperature (K).
r : Field[IJ, float]
    Water vapor mixing ratio (kg/kg).
pblh : float
    Planetary boundary layer height (m).
    Negative values indicate unknown boundary layer height.
wcld : Field[IJ, float]
    Water and mixed-phase cloud cover fraction (0-1).
    Negative values indicate unknown cloud cover.
w2d : float
    Ratio between ice crystal concentration in dry vs wet regions.
    Used to maintain consistency between grid-box mean and subgrid parts.
sifrc : Field[IJ, float]
    Output: Subgrid-scale fraction with supersaturation w.r.t. ice (0-1).
ssio : Field[IJ, float]
    Output: Super-saturation w.r.t. ice in the supersaturated fraction.
ssiu : Field[IJ, float]
    Output: Sub-saturation w.r.t. ice in the subsaturated fraction.
w2d_out : Field[IJ, float]
    Output: Consistency factor between grid-box mean and subgrid parts.
rsi : Field[IJ, float]
    Output: Saturation mixing ratio over ice (kg/kg).</p>
<h4 id="ice3.functions.icecloud.icecloud--returns">Returns</h4>
<p>Tuple[Field[IJ, float], ...]
    Returns (sifrc, ssio, ssiu, w2d_out, rsi)</p>
<h4 id="ice3.functions.icecloud.icecloud--notes">Notes</h4>
<p>Algorithm Overview:
1. Compute relative humidity w.r.t. water (rhw) and ice (rhi)
2. Estimate subgrid-scale RH variability from:
   - Horizontal variability (sigmax, sigmay)
   - Vertical variability (sigmaz or drhdz)
   - Boundary layer vs free troposphere differences
3. Determine the fraction of the grid cell that is supersaturated
4. Compute mean supersaturation in saturated and unsaturated parts</p>
<p>Assumptions:
- Linear distribution of relative humidity
- RH variability scales with grid spacing and layer thickness
- Enhanced variability in the boundary layer
- Reduced variability aloft where vertical RH gradients dominate</p>
<p>External Parameters:
- TSTEP: Model time step (s)
- LVTT: Latent heat of vaporization at triple point (J/kg)
- GRAVITY0: Gravitational acceleration (m/s²)
- RD: Gas constant for dry air (J/(kg·K))
- CPD: Specific heat of dry air at constant pressure (J/(kg·K))
- EPSILO: Ratio of molecular weights (Mw/Md ≈ 0.622)</p>
<p>Physical Constants:
- sigmax = sigmay = 3×10⁻⁴: Assumed horizontal RH variability
- sigmaz = 1×10⁻²: Assumed vertical RH variability
- xdist = ydist = 2500 m: Assumed grid spacing</p>
<p>Special Cases:
- T &gt; 273.1 K: No ice supersaturation computed (all liquid)
- r ≤ 0: No moisture, no supersaturation
- e_sat_i ≥ 0.5·p: Pressure too low for valid ice saturation</p>
<h4 id="ice3.functions.icecloud.icecloud--references">References</h4>
<p>This implements a subgrid-scale cloud scheme similar to those
used in climate models to represent unresolved cloud variability.
The method allows for partial cloud cover and accounts for
supersaturation needed for ice crystal nucleation and growth.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/ice3/functions/icecloud.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">icecloud</span><span class="p">(</span>
    <span class="n">p</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="n">IJ</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">z</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="n">IJ</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">dz</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="n">IJ</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="n">IJ</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">r</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="n">IJ</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">pblh</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">wcld</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="n">IJ</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">w2d</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">sifrc</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="n">IJ</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">ssio</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="n">IJ</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">ssiu</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="n">IJ</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">w2d_out</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="n">IJ</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">rsi</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="n">IJ</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate subgrid-scale supersaturation fraction with respect to ice.</span>

<span class="sd">    This function computes the fraction of a grid cell that is</span>
<span class="sd">    supersaturated with respect to ice, accounting for subgrid-scale</span>
<span class="sd">    variability in relative humidity. It assumes a linear distribution</span>
<span class="sd">    of relative humidity within the grid cell, with variability that</span>
<span class="sd">    depends on model level thickness and boundary layer characteristics.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p : Field[IJ, float]</span>
<span class="sd">        Pressure at model level (Pa).</span>
<span class="sd">    z : Field[IJ, float]</span>
<span class="sd">        Model level height above ground (m).</span>
<span class="sd">    dz : Field[IJ, float]</span>
<span class="sd">        Model level thickness (m).</span>
<span class="sd">    t : Field[IJ, float]</span>
<span class="sd">        Temperature (K).</span>
<span class="sd">    r : Field[IJ, float]</span>
<span class="sd">        Water vapor mixing ratio (kg/kg).</span>
<span class="sd">    pblh : float</span>
<span class="sd">        Planetary boundary layer height (m).</span>
<span class="sd">        Negative values indicate unknown boundary layer height.</span>
<span class="sd">    wcld : Field[IJ, float]</span>
<span class="sd">        Water and mixed-phase cloud cover fraction (0-1).</span>
<span class="sd">        Negative values indicate unknown cloud cover.</span>
<span class="sd">    w2d : float</span>
<span class="sd">        Ratio between ice crystal concentration in dry vs wet regions.</span>
<span class="sd">        Used to maintain consistency between grid-box mean and subgrid parts.</span>
<span class="sd">    sifrc : Field[IJ, float]</span>
<span class="sd">        Output: Subgrid-scale fraction with supersaturation w.r.t. ice (0-1).</span>
<span class="sd">    ssio : Field[IJ, float]</span>
<span class="sd">        Output: Super-saturation w.r.t. ice in the supersaturated fraction.</span>
<span class="sd">    ssiu : Field[IJ, float]</span>
<span class="sd">        Output: Sub-saturation w.r.t. ice in the subsaturated fraction.</span>
<span class="sd">    w2d_out : Field[IJ, float]</span>
<span class="sd">        Output: Consistency factor between grid-box mean and subgrid parts.</span>
<span class="sd">    rsi : Field[IJ, float]</span>
<span class="sd">        Output: Saturation mixing ratio over ice (kg/kg).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[Field[IJ, float], ...]</span>
<span class="sd">        Returns (sifrc, ssio, ssiu, w2d_out, rsi)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Algorithm Overview:</span>
<span class="sd">    1. Compute relative humidity w.r.t. water (rhw) and ice (rhi)</span>
<span class="sd">    2. Estimate subgrid-scale RH variability from:</span>
<span class="sd">       - Horizontal variability (sigmax, sigmay)</span>
<span class="sd">       - Vertical variability (sigmaz or drhdz)</span>
<span class="sd">       - Boundary layer vs free troposphere differences</span>
<span class="sd">    3. Determine the fraction of the grid cell that is supersaturated</span>
<span class="sd">    4. Compute mean supersaturation in saturated and unsaturated parts</span>

<span class="sd">    Assumptions:</span>
<span class="sd">    - Linear distribution of relative humidity</span>
<span class="sd">    - RH variability scales with grid spacing and layer thickness</span>
<span class="sd">    - Enhanced variability in the boundary layer</span>
<span class="sd">    - Reduced variability aloft where vertical RH gradients dominate</span>

<span class="sd">    External Parameters:</span>
<span class="sd">    - TSTEP: Model time step (s)</span>
<span class="sd">    - LVTT: Latent heat of vaporization at triple point (J/kg)</span>
<span class="sd">    - GRAVITY0: Gravitational acceleration (m/s²)</span>
<span class="sd">    - RD: Gas constant for dry air (J/(kg·K))</span>
<span class="sd">    - CPD: Specific heat of dry air at constant pressure (J/(kg·K))</span>
<span class="sd">    - EPSILO: Ratio of molecular weights (Mw/Md ≈ 0.622)</span>

<span class="sd">    Physical Constants:</span>
<span class="sd">    - sigmax = sigmay = 3×10⁻⁴: Assumed horizontal RH variability</span>
<span class="sd">    - sigmaz = 1×10⁻²: Assumed vertical RH variability</span>
<span class="sd">    - xdist = ydist = 2500 m: Assumed grid spacing</span>

<span class="sd">    Special Cases:</span>
<span class="sd">    - T &gt; 273.1 K: No ice supersaturation computed (all liquid)</span>
<span class="sd">    - r ≤ 0: No moisture, no supersaturation</span>
<span class="sd">    - e_sat_i ≥ 0.5·p: Pressure too low for valid ice saturation</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    This implements a subgrid-scale cloud scheme similar to those</span>
<span class="sd">    used in climate models to represent unresolved cloud variability.</span>
<span class="sd">    The method allows for partial cloud cover and accounts for</span>
<span class="sd">    supersaturation needed for ice crystal nucleation and growth.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">__externals__</span><span class="w"> </span><span class="kn">import</span> <span class="n">TSTEP</span><span class="p">,</span> <span class="n">LVTT</span><span class="p">,</span> <span class="n">GRAVITY0</span><span class="p">,</span> <span class="n">RD</span><span class="p">,</span> <span class="n">CPD</span><span class="p">,</span> <span class="n">EPSILO</span>

    <span class="c1"># Assumed RH variability in horizontal and vertical directions</span>
    <span class="n">sigmax</span> <span class="o">=</span> <span class="mf">3e-4</span>  <span class="c1"># assumed rh variation in x axis direction</span>
    <span class="n">sigmay</span> <span class="o">=</span> <span class="n">sigmax</span>  <span class="c1"># assumed rh variation in y axis direction</span>
    <span class="n">sigmaz</span> <span class="o">=</span> <span class="mf">1e-2</span>  <span class="c1"># assumed rh variation in vertical</span>

    <span class="n">xdist</span> <span class="o">=</span> <span class="mi">2500</span>  <span class="c1"># gridsize in x axis (m)</span>
    <span class="n">ydist</span> <span class="o">=</span> <span class="n">xdist</span>  <span class="c1"># gridsize in y axis (m)</span>

    <span class="c1"># Ensure non-negative mixing ratio</span>
    <span class="n">zr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">TSTEP</span><span class="p">)</span>
    <span class="n">sifrc</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Compute vapor pressure from mixing ratio</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">zr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">EPSILO</span> <span class="o">+</span> <span class="n">zr</span><span class="p">)</span>

    <span class="c1"># Compute relative humidity w.r.t. water and ice</span>
    <span class="n">rhw</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">esatw</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">rhi</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">esati</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Ratio of saturation vapor pressures (water/ice)</span>
    <span class="n">i2w</span> <span class="o">=</span> <span class="n">esatw</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">esati</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Initialize supersaturation values</span>
    <span class="n">ssiu</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i2w</span><span class="p">,</span> <span class="n">rhi</span><span class="p">)</span>
    <span class="n">ssio</span> <span class="o">=</span> <span class="n">ssiu</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">w2d</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Check if ice supersaturation is physically possible</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">273.1</span> <span class="ow">or</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">esati</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="c1"># Conditions not suitable for ice supersaturation</span>
        <span class="n">ssiu</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">ssio</span> <span class="o">=</span> <span class="n">ssiu</span>
        <span class="k">if</span> <span class="n">wcld</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sifrc</span> <span class="o">=</span> <span class="n">wcld</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Compute vertical RH gradient</span>
    <span class="n">rhin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">rhw</span><span class="p">))</span>
    <span class="n">drhdz</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">rhin</span> <span class="o">*</span> <span class="n">GRAVITY0</span> <span class="o">/</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">RD</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">EPSILO</span> <span class="o">*</span> <span class="n">LVTT</span> <span class="o">/</span> <span class="p">(</span><span class="n">CPD</span> <span class="o">*</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Determine if we&#39;re in boundary layer or free troposphere</span>
    <span class="n">zz</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">pblh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Boundary layer height unknown - use height-based estimate</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.001</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">35</span> <span class="ow">and</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pblh</span><span class="p">:</span>
        <span class="c1"># Above boundary layer</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Compute total RH variability from horizontal and vertical components</span>
    <span class="n">rhdist</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span>
        <span class="n">xdist</span> <span class="o">*</span> <span class="n">sigmax</span><span class="o">**</span><span class="mi">2</span>
        <span class="o">+</span> <span class="n">ydist</span> <span class="o">*</span> <span class="n">sigmay</span><span class="o">**</span><span class="mi">2</span>
        <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">zz</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">dz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">drhdz</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="o">+</span> <span class="n">zz</span> <span class="o">*</span> <span class="n">dz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sigmaz</span><span class="o">**</span><span class="mi">2</span>
    <span class="p">)</span>

    <span class="c1"># Normalize RH variation in free troposphere</span>
    <span class="k">if</span> <span class="n">zz</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
        <span class="n">rhdist</span> <span class="o">/=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">rhdist</span>

    <span class="c1"># Compute RH threshold for cloud formation</span>
    <span class="n">rhlim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">rhdist</span><span class="p">))</span>

    <span class="c1"># Estimate cloud cover if not provided</span>
    <span class="k">if</span> <span class="n">wcld</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">rhdif</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rhw</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rhlim</span><span class="p">)))</span>
        <span class="n">wcld</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">rhdif</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wcld</span> <span class="o">=</span> <span class="n">wcld</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">sifrc</span> <span class="o">=</span> <span class="n">wcld</span>

    <span class="c1"># Compute ice supersaturation threshold</span>
    <span class="n">rhlimice</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i2w</span> <span class="o">*</span> <span class="p">(</span><span class="n">rhlim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rhlim</span> <span class="o">&lt;</span> <span class="mf">0.999</span><span class="p">:</span>
        <span class="n">rhliminv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rhlimice</span><span class="p">)</span>
        <span class="n">rhdif</span> <span class="o">=</span> <span class="p">(</span><span class="n">rhi</span> <span class="o">-</span> <span class="n">rhlimice</span><span class="p">)</span> <span class="o">*</span> <span class="n">rhliminv</span>

        <span class="k">if</span> <span class="n">wcld</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># No pre-existing cloud - compute supersaturated fraction</span>
            <span class="n">sifrc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rhdif</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Adjust for existing cloud cover</span>
            <span class="n">sifrc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rhlim</span><span class="p">))</span>
            <span class="n">sifrc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">wcld</span> <span class="o">+</span> <span class="n">sifrc</span><span class="p">)</span>

    <span class="c1"># Compute mean supersaturation in each fraction</span>
    <span class="k">if</span> <span class="n">sifrc</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
        <span class="n">ssiu</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rhlim</span><span class="p">))</span>
        <span class="n">ssio</span> <span class="o">=</span> <span class="p">(</span><span class="n">rhi</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sifrc</span><span class="p">)</span> <span class="o">*</span> <span class="n">ssiu</span><span class="p">)</span> <span class="o">/</span> <span class="n">sifrc</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sifrc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rhlim</span><span class="p">))</span>
        <span class="n">ssiu</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sifrc</span> <span class="o">+</span> <span class="n">rhlimice</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sifrc</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>

    <span class="c1"># Convert to supersaturation (Si - 1)</span>
    <span class="n">ssiu</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">ssio</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="c1"># Compute consistency factor if needed</span>
    <span class="k">if</span> <span class="n">w2d</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">w2d_out</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w2d</span><span class="p">)</span> <span class="o">*</span> <span class="n">sifrc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sifrc</span><span class="p">,</span> <span class="n">ssio</span><span class="p">,</span> <span class="n">ssiu</span><span class="p">,</span> <span class="n">w2d_out</span><span class="p">,</span> <span class="n">rsi</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../ice_adjust/" class="btn btn-neutral float-left" title="Ice adjust"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../interp_micro/" class="btn btn-neutral float-right" title="Interp micro">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../ice_adjust/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../interp_micro/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
