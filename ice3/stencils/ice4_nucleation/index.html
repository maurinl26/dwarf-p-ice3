<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Ice4 nucleation - dwarf-ice3-gt4py</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Ice4 nucleation";
        var mkdocs_page_input_path = "ice3/stencils/ice4_nucleation.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> dwarf-ice3-gt4py
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../translation_options/">Translation Notes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../namelists/">Namelists</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">drivers</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../drivers/cli/">Cli</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../drivers/core/">Core</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ice3</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" >components</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../components/ice4_tendencies/">Ice4 tendencies</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../components/ice_adjust/">Ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../components/ice_adjust_modular/">Ice adjust modular</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../components/rain_ice/">Rain ice</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >functions</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/backup/">Backup</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/compute_ice_fraction/">Compute ice fraction</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/gamma/">Gamma</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/ice_adjust/">Ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/icecloud/">Icecloud</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/interp_micro/">Interp micro</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/sign/">Sign</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/temperature/">Temperature</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/tiwmx/">Tiwmx</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/upwind_sedimentation/">Upwind sedimentation</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >initialisation</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../initialisation/state_ice4_tendencies/">State ice4 tendencies</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../initialisation/state_ice_adjust/">State ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../initialisation/state_rain_ice/">State rain ice</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >phyex_common</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/constants/">Constants</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/ice_parameters/">Ice parameters</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/incomplete_gamma/">Incomplete gamma</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/lookup_table/">Lookup table</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/namparar/">Namparar</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/nebn/">Nebn</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/phyex/">Phyex</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/phyex_dimensions/">Phyex dimensions</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/rain_ice_descriptors/">Rain ice descriptors</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/rain_ice_field_address/">Rain ice field address</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/rain_ice_parameters/">Rain ice parameters</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/xker_raccs/">Xker raccs</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/xker_rdryg/">Xker rdryg</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/xker_sdryg/">Xker sdryg</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >stencils</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../ice4_compute_pdf/">Ice4 compute pdf</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_correct_negativities/">Ice4 correct negativities</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_fast_rg/">Ice4 fast rg</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_fast_ri/">Ice4 fast ri</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_fast_rs/">Ice4 fast rs</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Ice4 nucleation</a>
    <ul class="current">
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_rimltc/">Ice4 rimltc</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_rrhong/">Ice4 rrhong</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_slow/">Ice4 slow</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_stepping/">Ice4 stepping</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_tendencies/">Ice4 tendencies</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_warm/">Ice4 warm</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice_adjust/">Ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="" href="../rain_ice_nucleation.md">None</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../cloud_fraction/">Cloud fraction</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../condensation/">Condensation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../precipitation_fraction_liquid_content/">Precipitation fraction liquid content</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../rain_ice/">Rain ice</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../sedimentation/">Sedimentation</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >utils</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/allocate_random_fields/">Allocate random fields</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/allocate_state/">Allocate state</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/array_dict_operations/">Array dict operations</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/compile_fortran/">Compile fortran</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/doctor_norm/">Doctor norm</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/env/">Env</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/storage/">Storage</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >testprogs_data</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../testprogs_data/main/">Main</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../testprogs_data/utils/">Utils</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >agent</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/ICE4_TENDENCIES_STATUS/">ICE4 Tendencies JAX Translation Status</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../../agent/RAIN_ICE_TRANSITION_PLAN.md">None</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/README_ice_adjust_modular/">Composant ICE_ADJUST Modulaire</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/TRANSLATION_SUMMARY/">JAX Translation Summary</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/README_cloud_fraction/">Test de reproductibilité - cloud_fraction.py vs PHYEX-IAL_CY50T1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/README_condensation/">Test de reproductibilité - condensation.py vs PHYEX-IAL_CY50T1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/test_ice4_fast_rg_FIXES/">Fixes Applied to test_ice4_fast_rg.py</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/test_ice4_fast_rs_FIXES/">Fixes Applied to test_ice4_fast_rs.py</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/test_sigrc_computation_FIXES/">Fixes Applied to test_sigrc_computation.py</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">dwarf-ice3-gt4py</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">ice3</li>
          <li class="breadcrumb-item">stencils</li>
      <li class="breadcrumb-item active">Ice4 nucleation</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <div class="doc doc-object doc-module">



<a id="ice3.stencils.ice4_nucleation"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ice3.stencils.ice4_nucleation.ice4_nucleation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ice4_nucleation</span><span class="p">(</span><span class="n">ldcompute</span><span class="p">,</span> <span class="n">tht</span><span class="p">,</span> <span class="n">pabst</span><span class="p">,</span> <span class="n">rhodref</span><span class="p">,</span> <span class="n">exn</span><span class="p">,</span> <span class="n">lsfact</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">rvt</span><span class="p">,</span> <span class="n">cit</span><span class="p">,</span> <span class="n">rvheni_mr</span><span class="p">,</span> <span class="n">ssi</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Compute heterogeneous ice nucleation through water vapor deposition.</p>
<p>This stencil computes ice crystal nucleation by heterogeneous nucleation on ice
nuclei (HENI process). The nucleation rate depends on temperature and supersaturation
over ice (ssi). The scheme uses empirical parameterizations that distinguish between
different temperature regimes:
- T &lt; -5°C: Uses NU20 parameterization with supersaturation dependency
- -5°C ≤ T &lt; -2°C: Transition regime using max of two parameterizations
- T ≥ -2°C: No nucleation</p>
<p>The supersaturation over ice is computed from the water vapor mixing ratio and
limited by the supersaturation of water-saturated air over ice to ensure physical
consistency. An optional temperature feedback (LFEEDBACKT) limits nucleation to
prevent temperature from exceeding the freezing point.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>ldcompute</code></b>
                  (<code><span title="gt4py.cartesian.gtscript.Field">Field</span>[<span title="bool">bool</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Computation mask for microphysical sources - true where nucleation is computed</p>
              </div>
            </li>
            <li>
              <b><code>tht</code></b>
                  (<code><span title="gt4py.cartesian.gtscript.Field">Field</span>[<span title="float">float</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Potential temperature at time t (K)</p>
              </div>
            </li>
            <li>
              <b><code>pabst</code></b>
                  (<code><span title="gt4py.cartesian.gtscript.Field">Field</span>[<span title="float">float</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Absolute pressure at time t (Pa)</p>
              </div>
            </li>
            <li>
              <b><code>rhodref</code></b>
                  (<code><span title="gt4py.cartesian.gtscript.Field">Field</span>[<span title="float">float</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Reference air density (kg/m³)</p>
              </div>
            </li>
            <li>
              <b><code>exn</code></b>
                  (<code><span title="gt4py.cartesian.gtscript.Field">Field</span>[<span title="float">float</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Exner function (dimensionless pressure) at time t</p>
              </div>
            </li>
            <li>
              <b><code>lsfact</code></b>
                  (<code><span title="gt4py.cartesian.gtscript.Field">Field</span>[<span title="float">float</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Latent heat factor for sublimation (K·kg/kg), used for temperature feedback</p>
              </div>
            </li>
            <li>
              <b><code>t</code></b>
                  (<code><span title="gt4py.cartesian.gtscript.Field">Field</span>[<span title="float">float</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Temperature (K)</p>
              </div>
            </li>
            <li>
              <b><code>rvt</code></b>
                  (<code><span title="gt4py.cartesian.gtscript.Field">Field</span>[<span title="float">float</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Water vapor mixing ratio at time t (kg/kg)</p>
              </div>
            </li>
            <li>
              <b><code>cit</code></b>
                  (<code><span title="gt4py.cartesian.gtscript.Field">Field</span>[<span title="float">float</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Input/Output - Ice crystal number concentration at time t (1/kg), updated by nucleation</p>
              </div>
            </li>
            <li>
              <b><code>rvheni_mr</code></b>
                  (<code><span title="gt4py.cartesian.gtscript.Field">Field</span>[<span title="float">float</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Output - Water vapor mixing ratio change due to heterogeneous nucleation (kg/kg)</p>
              </div>
            </li>
            <li>
              <b><code>ssi</code></b>
                  (<code><span title="gt4py.cartesian.gtscript.Field">Field</span>[<span title="float">float</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Output - Supersaturation over ice (dimensionless), computed from vapor and temperature</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/ice3/stencils/ice4_nucleation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ice4_nucleation</span><span class="p">(</span>
    <span class="n">ldcompute</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;bool&quot;</span><span class="p">],</span>
    <span class="n">tht</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">pabst</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">rhodref</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">exn</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">lsfact</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">rvt</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">cit</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">rvheni_mr</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">ssi</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute heterogeneous ice nucleation through water vapor deposition.</span>

<span class="sd">    This stencil computes ice crystal nucleation by heterogeneous nucleation on ice</span>
<span class="sd">    nuclei (HENI process). The nucleation rate depends on temperature and supersaturation</span>
<span class="sd">    over ice (ssi). The scheme uses empirical parameterizations that distinguish between</span>
<span class="sd">    different temperature regimes:</span>
<span class="sd">    - T &lt; -5°C: Uses NU20 parameterization with supersaturation dependency</span>
<span class="sd">    - -5°C ≤ T &lt; -2°C: Transition regime using max of two parameterizations</span>
<span class="sd">    - T ≥ -2°C: No nucleation</span>

<span class="sd">    The supersaturation over ice is computed from the water vapor mixing ratio and</span>
<span class="sd">    limited by the supersaturation of water-saturated air over ice to ensure physical</span>
<span class="sd">    consistency. An optional temperature feedback (LFEEDBACKT) limits nucleation to</span>
<span class="sd">    prevent temperature from exceeding the freezing point.</span>

<span class="sd">    Args:</span>
<span class="sd">        ldcompute (Field[bool]): Computation mask for microphysical sources - true where nucleation is computed</span>
<span class="sd">        tht (Field[float]): Potential temperature at time t (K)</span>
<span class="sd">        pabst (Field[float]): Absolute pressure at time t (Pa)</span>
<span class="sd">        rhodref (Field[float]): Reference air density (kg/m³)</span>
<span class="sd">        exn (Field[float]): Exner function (dimensionless pressure) at time t</span>
<span class="sd">        lsfact (Field[float]): Latent heat factor for sublimation (K·kg/kg), used for temperature feedback</span>
<span class="sd">        t (Field[float]): Temperature (K)</span>
<span class="sd">        rvt (Field[float]): Water vapor mixing ratio at time t (kg/kg)</span>
<span class="sd">        cit (Field[float]): Input/Output - Ice crystal number concentration at time t (1/kg), updated by nucleation</span>
<span class="sd">        rvheni_mr (Field[float]): Output - Water vapor mixing ratio change due to heterogeneous nucleation (kg/kg)</span>
<span class="sd">        ssi (Field[float]): Output - Supersaturation over ice (dimensionless), computed from vapor and temperature</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">__externals__</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">ALPHA1</span><span class="p">,</span> <span class="n">ALPHA2</span><span class="p">,</span> <span class="n">ALPI</span><span class="p">,</span> <span class="n">ALPW</span><span class="p">,</span> <span class="n">BETA1</span><span class="p">,</span> <span class="n">BETA2</span><span class="p">,</span> <span class="n">BETAI</span><span class="p">,</span>
                               <span class="n">BETAW</span><span class="p">,</span> <span class="n">EPSILO</span><span class="p">,</span> <span class="n">GAMI</span><span class="p">,</span> <span class="n">GAMW</span><span class="p">,</span> <span class="n">LFEEDBACKT</span><span class="p">,</span> <span class="n">MNU0</span><span class="p">,</span>
                               <span class="n">NU10</span><span class="p">,</span> <span class="n">NU20</span><span class="p">,</span> <span class="n">TT</span><span class="p">,</span> <span class="n">V_RTMIN</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">computation</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">),</span> <span class="n">interval</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="n">usw</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">zw</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># l72</span>
    <span class="k">with</span> <span class="n">computation</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">),</span> <span class="n">interval</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">TT</span> <span class="ow">and</span> <span class="n">rvt</span> <span class="o">&gt;</span> <span class="n">V_RTMIN</span> <span class="ow">and</span> <span class="n">ldcompute</span><span class="p">:</span>
            <span class="n">zw</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">usw</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">ALPW</span> <span class="o">-</span> <span class="n">BETAW</span> <span class="o">/</span> <span class="n">t</span> <span class="o">-</span> <span class="n">GAMW</span> <span class="o">*</span> <span class="n">zw</span><span class="p">)</span>
            <span class="n">zw</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">ALPI</span> <span class="o">-</span> <span class="n">BETAI</span> <span class="o">/</span> <span class="n">t</span> <span class="o">-</span> <span class="n">GAMI</span> <span class="o">*</span> <span class="n">zw</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">computation</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">),</span> <span class="n">interval</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="n">ssi</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># l83</span>
    <span class="k">with</span> <span class="n">computation</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">),</span> <span class="n">interval</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">TT</span> <span class="ow">and</span> <span class="n">rvt</span> <span class="o">&gt;</span> <span class="n">V_RTMIN</span> <span class="ow">and</span> <span class="n">ldcompute</span><span class="p">:</span>
            <span class="n">zw</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pabst</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">zw</span><span class="p">)</span>
            <span class="n">ssi</span> <span class="o">=</span> <span class="n">rvt</span> <span class="o">*</span> <span class="p">(</span><span class="n">pabst</span> <span class="o">-</span> <span class="n">zw</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">EPSILO</span> <span class="o">*</span> <span class="n">zw</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="c1"># supersaturation over ice</span>

            <span class="n">usw</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pabst</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">usw</span><span class="p">)</span>
            <span class="n">usw</span> <span class="o">=</span> <span class="p">(</span><span class="n">usw</span> <span class="o">/</span> <span class="n">zw</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">pabst</span> <span class="o">-</span> <span class="n">zw</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">pabst</span> <span class="o">-</span> <span class="n">usw</span><span class="p">))</span> <span class="o">-</span> <span class="mf">1.0</span>
            <span class="c1"># supersaturation of saturated water vapor over ice</span>

            <span class="n">ssi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ssi</span><span class="p">,</span> <span class="n">usw</span><span class="p">)</span>  <span class="c1"># limitation of ssi according to ssw = 0</span>

    <span class="c1"># l96</span>
    <span class="k">with</span> <span class="n">computation</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">),</span> <span class="n">interval</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="n">zw</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">with</span> <span class="n">computation</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">),</span> <span class="n">interval</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">TT</span> <span class="ow">and</span> <span class="n">rvt</span> <span class="o">&gt;</span> <span class="n">V_RTMIN</span> <span class="ow">and</span> <span class="n">ldcompute</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">TT</span> <span class="o">-</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">ssi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">zw</span> <span class="o">=</span> <span class="n">NU20</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="n">ALPHA2</span> <span class="o">*</span> <span class="n">ssi</span> <span class="o">-</span> <span class="n">BETA2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">TT</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">TT</span> <span class="o">-</span> <span class="mf">5.0</span> <span class="ow">and</span> <span class="n">ssi</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">zw</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="n">NU20</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">BETA2</span><span class="p">),</span>
                    <span class="n">NU10</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">BETA1</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">TT</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">ssi</span> <span class="o">/</span> <span class="n">usw</span><span class="p">)</span> <span class="o">**</span> <span class="n">ALPHA1</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="c1"># l107</span>
    <span class="k">with</span> <span class="n">computation</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">),</span> <span class="n">interval</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">TT</span> <span class="ow">and</span> <span class="n">rvt</span> <span class="o">&gt;</span> <span class="n">V_RTMIN</span> <span class="ow">and</span> <span class="n">ldcompute</span><span class="p">:</span>
            <span class="n">zw</span> <span class="o">=</span> <span class="n">zw</span> <span class="o">-</span> <span class="n">cit</span>
            <span class="n">zw</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">zw</span><span class="p">,</span> <span class="mf">5e4</span><span class="p">)</span>

    <span class="c1"># l114</span>
    <span class="k">with</span> <span class="n">computation</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">),</span> <span class="n">interval</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="n">rvheni_mr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">TT</span> <span class="ow">and</span> <span class="n">rvt</span> <span class="o">&gt;</span> <span class="n">V_RTMIN</span> <span class="ow">and</span> <span class="n">ldcompute</span><span class="p">:</span>
            <span class="n">rvheni_mr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">zw</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">MNU0</span> <span class="o">/</span> <span class="n">rhodref</span>
            <span class="n">rvheni_mr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rvt</span><span class="p">,</span> <span class="n">rvheni_mr</span><span class="p">)</span>

    <span class="c1"># l122</span>
    <span class="k">with</span> <span class="n">computation</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">),</span> <span class="n">interval</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">LFEEDBACKT</span><span class="p">:</span>
            <span class="n">w1</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">TT</span> <span class="ow">and</span> <span class="n">rvt</span> <span class="o">&gt;</span> <span class="n">V_RTMIN</span> <span class="ow">and</span> <span class="n">ldcompute</span><span class="p">:</span>
                <span class="n">w1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rvheni_mr</span><span class="p">,</span> 
                         <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">TT</span> <span class="o">/</span> <span class="n">exn</span> <span class="o">-</span> <span class="n">tht</span><span class="p">))</span> <span class="o">/</span> <span class="n">lsfact</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="n">rvheni_mr</span><span class="p">,</span> <span class="mf">1e-20</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w1</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">if</span> <span class="n">LFEEDBACKT</span><span class="p">:</span>
            <span class="n">rvheni_mr</span> <span class="o">=</span> <span class="n">rvheni_mr</span> <span class="o">*</span> <span class="n">w1</span>
            <span class="n">zw</span> <span class="o">=</span> <span class="n">zw</span> <span class="o">*</span> <span class="n">w1</span>

    <span class="c1"># l134</span>
    <span class="k">with</span> <span class="n">computation</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">),</span> <span class="n">interval</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">TT</span> <span class="ow">and</span> <span class="n">rvt</span> <span class="o">&gt;</span> <span class="n">V_RTMIN</span> <span class="ow">and</span> <span class="n">ldcompute</span><span class="p">:</span>
            <span class="n">cit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">zw</span> <span class="o">+</span> <span class="n">cit</span><span class="p">,</span> <span class="n">cit</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../ice4_fast_rs/" class="btn btn-neutral float-left" title="Ice4 fast rs"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../ice4_rimltc/" class="btn btn-neutral float-right" title="Ice4 rimltc">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../ice4_fast_rs/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../ice4_rimltc/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
