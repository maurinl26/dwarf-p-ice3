<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Cloud fraction - dwarf-ice3-gt4py</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Cloud fraction";
        var mkdocs_page_input_path = "ice3/stencils/cloud_fraction.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> dwarf-ice3-gt4py
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../translation_options/">Translation Notes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../namelists/">Namelists</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">drivers</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../drivers/cli/">Cli</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../drivers/core/">Core</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">ice3</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" >components</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../components/ice4_tendencies/">Ice4 tendencies</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../components/ice_adjust/">Ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../components/ice_adjust_modular/">Ice adjust modular</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../components/rain_ice/">Rain ice</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >functions</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/backup/">Backup</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/compute_ice_fraction/">Compute ice fraction</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/gamma/">Gamma</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/ice_adjust/">Ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/icecloud/">Icecloud</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/interp_micro/">Interp micro</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/sign/">Sign</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/temperature/">Temperature</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/tiwmx/">Tiwmx</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../functions/upwind_sedimentation/">Upwind sedimentation</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >initialisation</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../initialisation/state_ice4_tendencies/">State ice4 tendencies</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../initialisation/state_ice_adjust/">State ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../initialisation/state_rain_ice/">State rain ice</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >phyex_common</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/constants/">Constants</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/ice_parameters/">Ice parameters</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/incomplete_gamma/">Incomplete gamma</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/lookup_table/">Lookup table</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/namparar/">Namparar</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/nebn/">Nebn</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/phyex/">Phyex</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/phyex_dimensions/">Phyex dimensions</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/rain_ice_descriptors/">Rain ice descriptors</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/rain_ice_field_address/">Rain ice field address</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/rain_ice_parameters/">Rain ice parameters</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/xker_raccs/">Xker raccs</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/xker_rdryg/">Xker rdryg</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../phyex_common/xker_sdryg/">Xker sdryg</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >stencils</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../ice4_compute_pdf/">Ice4 compute pdf</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_correct_negativities/">Ice4 correct negativities</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_fast_rg/">Ice4 fast rg</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_fast_ri/">Ice4 fast ri</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_fast_rs/">Ice4 fast rs</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_nucleation/">Ice4 nucleation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_rimltc/">Ice4 rimltc</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_rrhong/">Ice4 rrhong</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_slow/">Ice4 slow</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_stepping/">Ice4 stepping</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_tendencies/">Ice4 tendencies</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice4_warm/">Ice4 warm</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ice_adjust/">Ice adjust</a>
                </li>
                <li class="toctree-l2"><a class="" href="../rain_ice_nucleation.md">None</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Cloud fraction</a>
    <ul class="current">
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../condensation/">Condensation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../precipitation_fraction_liquid_content/">Precipitation fraction liquid content</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../rain_ice/">Rain ice</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../sedimentation/">Sedimentation</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >utils</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/allocate_random_fields/">Allocate random fields</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/allocate_state/">Allocate state</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/array_dict_operations/">Array dict operations</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/compile_fortran/">Compile fortran</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/doctor_norm/">Doctor norm</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/env/">Env</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../utils/storage/">Storage</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >testprogs_data</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../testprogs_data/main/">Main</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../testprogs_data/utils/">Utils</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >agent</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/ICE4_TENDENCIES_STATUS/">ICE4 Tendencies JAX Translation Status</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../../agent/RAIN_ICE_TRANSITION_PLAN.md">None</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/README_ice_adjust_modular/">Composant ICE_ADJUST Modulaire</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/TRANSLATION_SUMMARY/">JAX Translation Summary</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/README_cloud_fraction/">Test de reproductibilité - cloud_fraction.py vs PHYEX-IAL_CY50T1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/README_condensation/">Test de reproductibilité - condensation.py vs PHYEX-IAL_CY50T1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/test_ice4_fast_rg_FIXES/">Fixes Applied to test_ice4_fast_rg.py</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/test_ice4_fast_rs_FIXES/">Fixes Applied to test_ice4_fast_rs.py</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../agent/test_sigrc_computation_FIXES/">Fixes Applied to test_sigrc_computation.py</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">dwarf-ice3-gt4py</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">ice3</li>
          <li class="breadcrumb-item">stencils</li>
      <li class="breadcrumb-item active">Cloud fraction</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <div class="doc doc-object doc-module">



<a id="ice3.stencils.cloud_fraction"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ice3.stencils.cloud_fraction.cloud_fraction_1" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cloud_fraction_1</span><span class="p">(</span><span class="n">lv</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">cph</span><span class="p">,</span> <span class="n">exnref</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">ths</span><span class="p">,</span> <span class="n">rvs</span><span class="p">,</span> <span class="n">rcs</span><span class="p">,</span> <span class="n">ris</span><span class="p">,</span> <span class="n">rc_tmp</span><span class="p">,</span> <span class="n">ri_tmp</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Compute mixing ratio sources from condensation/evaporation tendencies.</p>
<p>This stencil converts condensation tendencies into actual source terms
for the prognostic equations, applying conservative constraints and
updating potential temperature accordingly. It handles both liquid
(cloud droplets) and ice (crystals) phase changes.</p>
<h4 id="ice3.stencils.cloud_fraction.cloud_fraction_1--parameters">Parameters</h4>
<p>lv : Field[float]
    Latent heat of vaporization (J/kg). Input field.
ls : Field[float]
    Latent heat of sublimation (J/kg). Input field.
cph : Field[float]
    Specific heat of moist air (J/(kg·K)). Input field.
exnref : Field[float]
    Reference Exner function (dimensionless). Input field.
rc : Field[float]
    Initial cloud droplet mixing ratio (kg/kg). Input field.
ri : Field[float]
    Initial ice crystal mixing ratio (kg/kg). Input field.
ths : Field[float]
    Potential temperature source term (K/s). Modified in place.
rvs : Field[float]
    Water vapor source term (kg/kg/s). Modified in place.
rcs : Field[float]
    Cloud droplet source term (kg/kg/s). Modified in place.
ris : Field[float]
    Ice crystal source term (kg/kg/s). Modified in place.
rc_tmp : Field[float]
    Temporary cloud mixing ratio after condensation (kg/kg). Input field.
ri_tmp : Field[float]
    Temporary ice mixing ratio after deposition (kg/kg). Input field.
dt : float
    Physics time step (s). Scalar parameter.</p>
<h4 id="ice3.stencils.cloud_fraction.cloud_fraction_1--returns">Returns</h4>
<p>None
    Modifies ths, rvs, rcs, and ris in place.</p>
<h4 id="ice3.stencils.cloud_fraction.cloud_fraction_1--notes">Notes</h4>
<p><strong>Tendency Calculation:</strong></p>
<p>The condensation/deposition tendencies are computed as:</p>
<p>w₁ = (rc_tmp - rc) / Δt  (liquid condensation rate, kg/kg/s)
w₂ = (ri_tmp - ri) / Δt  (ice deposition rate, kg/kg/s)</p>
<p><strong>Conservative Constraints:</strong></p>
<p>For condensation (w &gt; 0):
- Limited by available vapor: w ≤ rv_s</p>
<p>For evaporation (w &lt; 0):
- Limited by available condensate: |w| ≤ rc_s or ri_s</p>
<p><strong>Mass Conservation:</strong></p>
<p>The vapor source is reduced by condensation/deposition:
rv_s → rv_s - w₁ - w₂</p>
<p>The condensate sources are increased:
rc_s → rc_s + w₁
ri_s → ri_s + w₂</p>
<p><strong>Temperature Tendency:</strong></p>
<p>Phase changes produce/consume latent heat:</p>
<p>dθ/dt = (w₁×L_v + w₂×L_s) / (c_ph × π)</p>
<ul>
<li>Condensation/deposition: dθ/dt &gt; 0 (warming)</li>
<li>Evaporation/sublimation: dθ/dt &lt; 0 (cooling)</li>
</ul>
<p><strong>Physical Interpretation:</strong></p>
<p>This stencil ensures:
1. Mass conservation (total water remains constant)
2. Energy conservation (latent heat properly accounted)
3. Physical realizability (no negative mixing ratios)
4. Numerical stability (limited changes per time step)</p>
<h4 id="ice3.stencils.cloud_fraction.cloud_fraction_1--source-reference">Source Reference</h4>
<p>PHYEX/src/common/micro/ice_adjust.F90, lines 278-312</p>
<h4 id="ice3.stencils.cloud_fraction.cloud_fraction_1--see-also">See Also</h4>
<p>thermodynamic_fields : Computes temperature and latent heats
cloud_fraction_2 : Subgrid cloud fraction and autoconversion</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/ice3/stencils/cloud_fraction.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cloud_fraction_1</span><span class="p">(</span>
    <span class="n">lv</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">ls</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">cph</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">exnref</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">rc</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">ri</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">ths</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">rvs</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">rcs</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">ris</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">rc_tmp</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">ri_tmp</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">dt</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute mixing ratio sources from condensation/evaporation tendencies.</span>

<span class="sd">    This stencil converts condensation tendencies into actual source terms</span>
<span class="sd">    for the prognostic equations, applying conservative constraints and</span>
<span class="sd">    updating potential temperature accordingly. It handles both liquid</span>
<span class="sd">    (cloud droplets) and ice (crystals) phase changes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lv : Field[float]</span>
<span class="sd">        Latent heat of vaporization (J/kg). Input field.</span>
<span class="sd">    ls : Field[float]</span>
<span class="sd">        Latent heat of sublimation (J/kg). Input field.</span>
<span class="sd">    cph : Field[float]</span>
<span class="sd">        Specific heat of moist air (J/(kg·K)). Input field.</span>
<span class="sd">    exnref : Field[float]</span>
<span class="sd">        Reference Exner function (dimensionless). Input field.</span>
<span class="sd">    rc : Field[float]</span>
<span class="sd">        Initial cloud droplet mixing ratio (kg/kg). Input field.</span>
<span class="sd">    ri : Field[float]</span>
<span class="sd">        Initial ice crystal mixing ratio (kg/kg). Input field.</span>
<span class="sd">    ths : Field[float]</span>
<span class="sd">        Potential temperature source term (K/s). Modified in place.</span>
<span class="sd">    rvs : Field[float]</span>
<span class="sd">        Water vapor source term (kg/kg/s). Modified in place.</span>
<span class="sd">    rcs : Field[float]</span>
<span class="sd">        Cloud droplet source term (kg/kg/s). Modified in place.</span>
<span class="sd">    ris : Field[float]</span>
<span class="sd">        Ice crystal source term (kg/kg/s). Modified in place.</span>
<span class="sd">    rc_tmp : Field[float]</span>
<span class="sd">        Temporary cloud mixing ratio after condensation (kg/kg). Input field.</span>
<span class="sd">    ri_tmp : Field[float]</span>
<span class="sd">        Temporary ice mixing ratio after deposition (kg/kg). Input field.</span>
<span class="sd">    dt : float</span>
<span class="sd">        Physics time step (s). Scalar parameter.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Modifies ths, rvs, rcs, and ris in place.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    **Tendency Calculation:**</span>

<span class="sd">    The condensation/deposition tendencies are computed as:</span>

<span class="sd">    w₁ = (rc_tmp - rc) / Δt  (liquid condensation rate, kg/kg/s)</span>
<span class="sd">    w₂ = (ri_tmp - ri) / Δt  (ice deposition rate, kg/kg/s)</span>

<span class="sd">    **Conservative Constraints:**</span>

<span class="sd">    For condensation (w &gt; 0):</span>
<span class="sd">    - Limited by available vapor: w ≤ rv_s</span>

<span class="sd">    For evaporation (w &lt; 0):</span>
<span class="sd">    - Limited by available condensate: |w| ≤ rc_s or ri_s</span>

<span class="sd">    **Mass Conservation:**</span>

<span class="sd">    The vapor source is reduced by condensation/deposition:</span>
<span class="sd">    rv_s → rv_s - w₁ - w₂</span>

<span class="sd">    The condensate sources are increased:</span>
<span class="sd">    rc_s → rc_s + w₁</span>
<span class="sd">    ri_s → ri_s + w₂</span>

<span class="sd">    **Temperature Tendency:**</span>

<span class="sd">    Phase changes produce/consume latent heat:</span>

<span class="sd">    dθ/dt = (w₁×L_v + w₂×L_s) / (c_ph × π)</span>

<span class="sd">    - Condensation/deposition: dθ/dt &gt; 0 (warming)</span>
<span class="sd">    - Evaporation/sublimation: dθ/dt &lt; 0 (cooling)</span>

<span class="sd">    **Physical Interpretation:**</span>

<span class="sd">    This stencil ensures:</span>
<span class="sd">    1. Mass conservation (total water remains constant)</span>
<span class="sd">    2. Energy conservation (latent heat properly accounted)</span>
<span class="sd">    3. Physical realizability (no negative mixing ratios)</span>
<span class="sd">    4. Numerical stability (limited changes per time step)</span>

<span class="sd">    Source Reference</span>
<span class="sd">    ----------------</span>
<span class="sd">    PHYEX/src/common/micro/ice_adjust.F90, lines 278-312</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    thermodynamic_fields : Computes temperature and latent heats</span>
<span class="sd">    cloud_fraction_2 : Subgrid cloud fraction and autoconversion</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># l274 in ice_adjust.F90</span>
    <span class="c1">##### 5.     COMPUTE THE SOURCES AND STORES THE CLOUD FRACTION #####</span>
    <span class="k">with</span> <span class="n">computation</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">),</span> <span class="n">interval</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="c1"># 5.0 compute the variation of mixing ratio</span>
        <span class="n">w1</span> <span class="o">=</span> <span class="p">(</span><span class="n">rc_tmp</span> <span class="o">-</span> <span class="n">rc</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span>
        <span class="n">w2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ri_tmp</span> <span class="o">-</span> <span class="n">ri</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span>

        <span class="c1"># 5.1 compute the sources</span>
        <span class="n">w1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="o">-</span><span class="n">rcs</span><span class="p">)</span> <span class="k">if</span> <span class="n">w1</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">rvs</span><span class="p">)</span>
        <span class="n">rvs</span> <span class="o">-=</span> <span class="n">w1</span>
        <span class="n">rcs</span> <span class="o">+=</span> <span class="n">w1</span>
        <span class="n">ths</span> <span class="o">+=</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">lv</span> <span class="o">/</span> <span class="p">(</span><span class="n">cph</span> <span class="o">*</span> <span class="n">exnref</span><span class="p">)</span>

        <span class="n">w2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">w2</span><span class="p">,</span> <span class="o">-</span><span class="n">ris</span><span class="p">)</span> <span class="k">if</span> <span class="n">w2</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="n">w2</span><span class="p">,</span> <span class="n">rvs</span><span class="p">)</span>
        <span class="n">rvs</span> <span class="o">-=</span> <span class="n">w2</span>
        <span class="n">ris</span> <span class="o">+=</span> <span class="n">w2</span>
        <span class="n">ths</span> <span class="o">+=</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">ls</span> <span class="o">/</span> <span class="p">(</span><span class="n">cph</span> <span class="o">*</span> <span class="n">exnref</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ice3.stencils.cloud_fraction.cloud_fraction_2" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cloud_fraction_2</span><span class="p">(</span><span class="n">rhodref</span><span class="p">,</span> <span class="n">exnref</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cph</span><span class="p">,</span> <span class="n">lv</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">ths</span><span class="p">,</span> <span class="n">rvs</span><span class="p">,</span> <span class="n">rcs</span><span class="p">,</span> <span class="n">ris</span><span class="p">,</span> <span class="n">rc_mf</span><span class="p">,</span> <span class="n">ri_mf</span><span class="p">,</span> <span class="n">cf_mf</span><span class="p">,</span> <span class="n">cldfr</span><span class="p">,</span> <span class="n">hlc_hrc</span><span class="p">,</span> <span class="n">hlc_hcf</span><span class="p">,</span> <span class="n">hli_hri</span><span class="p">,</span> <span class="n">hli_hcf</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Compute cloud fraction and subgrid autoconversion from mass flux condensate.</p>
<p>This stencil handles subgrid condensation from shallow convection mass fluxes
and computes the resulting cloud fraction. When enabled (LSUBG_COND=True), it
also calculates subgrid autoconversion using PDF-based methods, accounting for
sub-grid variability in condensate fields.</p>
<h4 id="ice3.stencils.cloud_fraction.cloud_fraction_2--parameters">Parameters</h4>
<p>rhodref : Field[float]
    Reference air density (kg/m³). Input field.
exnref : Field[float]
    Reference Exner function (dimensionless). Input field.
t : Field[float]
    Temperature (K). Input field.
cph : Field[float]
    Specific heat of moist air (J/(kg·K)). Input field.
lv : Field[float]
    Latent heat of vaporization (J/kg). Input field.
ls : Field[float]
    Latent heat of sublimation (J/kg). Input field.
ths : Field[float]
    Potential temperature source (K/s). Modified in place.
rvs : Field[float]
    Water vapor source (kg/kg/s). Modified in place.
rcs : Field[float]
    Cloud droplet source (kg/kg/s). Modified in place.
ris : Field[float]
    Ice crystal source (kg/kg/s). Modified in place.
rc_mf : Field[float]
    Cloud condensate from mass flux (kg/kg). Input field.
ri_mf : Field[float]
    Ice condensate from mass flux (kg/kg). Input field.
cf_mf : Field[float]
    Cloud fraction from mass flux (dimensionless, 0-1). Input field.
cldfr : Field[float]
    Total cloud fraction (dimensionless, 0-1). Modified in place.
hlc_hrc : Field[float]
    Liquid autoconversion amount (kg/kg). Modified in place.
hlc_hcf : Field[float]
    Liquid autoconversion cloud fraction (dimensionless). Modified in place.
hli_hri : Field[float]
    Ice autoconversion amount (kg/kg). Modified in place.
hli_hcf : Field[float]
    Ice autoconversion cloud fraction (dimensionless). Modified in place.
dt : float
    Physics time step (s). Scalar parameter.</p>
<h4 id="ice3.stencils.cloud_fraction.cloud_fraction_2--returns">Returns</h4>
<p>None
    Modifies cldfr, ths, rvs, rcs, ris, hlc_hrc, hlc_hcf, hli_hri, hli_hcf in place.</p>
<h4 id="ice3.stencils.cloud_fraction.cloud_fraction_2--notes">Notes</h4>
<p><strong>Two Operating Modes:</strong></p>
<ol>
<li><strong>Without Subgrid Condensation (LSUBG_COND=False):</strong></li>
<li>Binary cloud fraction: 0 or 1</li>
<li>Cloud present if (r_c + r_i) × Δt &gt; 10⁻¹²</li>
<li>
<p>Simple all-or-nothing approach</p>
</li>
<li>
<p><strong>With Subgrid Condensation (LSUBG_COND=True, AROME default):</strong></p>
</li>
<li>Partial cloud fractions from mass flux scheme</li>
<li>Subgrid autoconversion using PDF methods</li>
<li>Accounts for sub-grid variability</li>
</ol>
<p><strong>Mass Flux Condensate Processing:</strong></p>
<p>When LSUBG_COND is enabled:</p>
<ol>
<li>
<p>Convert mass flux condensate to rates:
   w₁ = rc_mf / Δt  (liquid rate, kg/kg/s)
   w₂ = ri_mf / Δt  (ice rate, kg/kg/s)</p>
</li>
<li>
<p>Conservatively limit to available vapor:
   If w₁ + w₂ &gt; rv_s:
       w₁ → w₁ × rv_s/(w₁ + w₂)
       w₂ → rv_s - w₁</p>
</li>
<li>
<p>Update cloud fraction additively:
   cf_total = min(1, cf_existing + cf_mf)</p>
</li>
<li>
<p>Update mixing ratios and temperature</p>
</li>
</ol>
<p><strong>Subgrid Autoconversion:</strong></p>
<p>Two PDF methods available via SUBG_MF_PDF:</p>
<p><strong>Method 0 (NONE - Step Function):</strong>
- Autoconversion occurs if condensate exceeds threshold
- Liquid: w₁×Δt &gt; cf_mf × (CRIAUTC/ρ)
- Ice: w₂×Δt &gt; cf_mf × CRIAUTI(T)
- All excess converts → rain/snow
- Cloud fraction set to mass flux value</p>
<p><strong>Method 1 (TRIANGLE - Triangular PDF):</strong>
- Assumes triangular sub-grid condensate distribution
- Calculates partial autoconversion
- More physical than step function</p>
<p>For triangular PDF, three regimes:</p>
<p>A. High condensate (q &gt; cf×r_crit):
   hcf = 1 - 0.5×(cf×r_crit/q)²
   hr = q - (cf×r_crit)³/(3q²)
   Large conversion, most of cloud converts</p>
<p>B. Low condensate (q ≤ 0.5×cf×r_crit):
   hcf = 0, hr = 0
   No autoconversion</p>
<p>C. Intermediate (0.5×cf×r_crit &lt; q ≤ cf×r_crit):
   hcf = (2q - cf×r_crit)²/(2q²)
   hr = [4q³ - 3q(cf×r_crit)² + (cf×r_crit)³]/(3q²)
   Partial conversion</p>
<p><strong>Autoconversion Thresholds:</strong></p>
<p>Liquid (cloud → rain):
r_crit = CRIAUTC / ρ_ref
Typical: ~5×10⁻⁴ kg/kg at surface</p>
<p>Ice (ice → snow):
r_crit(T) = min(CRIAUTI, 10^(A×(T-273.16) + B))
Temperature-dependent, increases with warming
Typical: ~2×10⁻⁵ kg/kg at -20°C</p>
<p><strong>Physical Interpretation:</strong></p>
<p>This stencil bridges the gap between:
- Resolved-scale condensation (explicit grid-box saturation)
- Unresolved shallow convection (mass flux parameterization)
- Sub-grid variability (PDF-based autoconversion)</p>
<p>It ensures smooth transition from small cumulus (mass flux)
to stratiform clouds (resolved) by additive cloud fractions.</p>
<p><strong>Diagnostic Outputs:</strong></p>
<p>hlc_hrc, hlc_hcf: Liquid autoconversion amount and cloud fraction
hli_hri, hli_hcf: Ice autoconversion amount and cloud fraction</p>
<p>These are used later for:
- Computing rain/snow production rates
- Diagnosing precipitation initiation
- Radiation calculations</p>
<h4 id="ice3.stencils.cloud_fraction.cloud_fraction_2--source-reference">Source Reference</h4>
<p>PHYEX/src/common/micro/ice_adjust.F90, lines 313-419</p>
<h4 id="ice3.stencils.cloud_fraction.cloud_fraction_2--see-also">See Also</h4>
<p>thermodynamic_fields : Temperature and latent heat computation
cloud_fraction_1 : Condensation source term computation
condensation : Main condensation scheme with CB02</p>
<h4 id="ice3.stencils.cloud_fraction.cloud_fraction_2--references">References</h4>
<p>Bougeault, P., 1981: Modeling the trade-wind cumulus boundary layer.
Part I: Testing the ensemble cloud relations against numerical data.
J. Atmos. Sci., 38, 2414-2428.</p>
<h4 id="ice3.stencils.cloud_fraction.cloud_fraction_2--examples">Examples</h4>
<blockquote>
<blockquote>
<blockquote>
<h3 id="ice3.stencils.cloud_fraction.cloud_fraction_2--binary-cloud-fraction-mode-lsubg_condfalse">Binary cloud fraction mode (LSUBG_COND=False)</h3>
<h3 id="ice3.stencils.cloud_fraction.cloud_fraction_2--if-total-condensate-threshold-cloud-fraction-1">If total condensate &gt; threshold → cloud fraction = 1</h3>
<h3 id="ice3.stencils.cloud_fraction.cloud_fraction_2--otherwise-cloud-fraction-0">Otherwise → cloud fraction = 0</h3>
<h3 id="ice3.stencils.cloud_fraction.cloud_fraction_2--pdf-based-mode-lsubg_condtrue-subg_mf_pdf1">PDF-based mode (LSUBG_COND=True, SUBG_MF_PDF=1)</h3>
<h3 id="ice3.stencils.cloud_fraction.cloud_fraction_2--partial-cloud-fractions-from-mass-flux">Partial cloud fractions from mass flux</h3>
<h3 id="ice3.stencils.cloud_fraction.cloud_fraction_2--subgrid-autoconversion-with-triangular-pdf">Subgrid autoconversion with triangular PDF</h3>
<h3 id="ice3.stencils.cloud_fraction.cloud_fraction_2--smooth-transitions-more-realistic-variability">Smooth transitions, more realistic variability</h3>
</blockquote>
</blockquote>
</blockquote>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/ice3/stencils/cloud_fraction.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cloud_fraction_2</span><span class="p">(</span>
    <span class="n">rhodref</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">exnref</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">cph</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">lv</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">ls</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">ths</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">rvs</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">rcs</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">ris</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">rc_mf</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">ri_mf</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">cf_mf</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">cldfr</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">hlc_hrc</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">hlc_hcf</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">hli_hri</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">hli_hcf</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">dt</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute cloud fraction and subgrid autoconversion from mass flux condensate.</span>

<span class="sd">    This stencil handles subgrid condensation from shallow convection mass fluxes</span>
<span class="sd">    and computes the resulting cloud fraction. When enabled (LSUBG_COND=True), it</span>
<span class="sd">    also calculates subgrid autoconversion using PDF-based methods, accounting for</span>
<span class="sd">    sub-grid variability in condensate fields.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rhodref : Field[float]</span>
<span class="sd">        Reference air density (kg/m³). Input field.</span>
<span class="sd">    exnref : Field[float]</span>
<span class="sd">        Reference Exner function (dimensionless). Input field.</span>
<span class="sd">    t : Field[float]</span>
<span class="sd">        Temperature (K). Input field.</span>
<span class="sd">    cph : Field[float]</span>
<span class="sd">        Specific heat of moist air (J/(kg·K)). Input field.</span>
<span class="sd">    lv : Field[float]</span>
<span class="sd">        Latent heat of vaporization (J/kg). Input field.</span>
<span class="sd">    ls : Field[float]</span>
<span class="sd">        Latent heat of sublimation (J/kg). Input field.</span>
<span class="sd">    ths : Field[float]</span>
<span class="sd">        Potential temperature source (K/s). Modified in place.</span>
<span class="sd">    rvs : Field[float]</span>
<span class="sd">        Water vapor source (kg/kg/s). Modified in place.</span>
<span class="sd">    rcs : Field[float]</span>
<span class="sd">        Cloud droplet source (kg/kg/s). Modified in place.</span>
<span class="sd">    ris : Field[float]</span>
<span class="sd">        Ice crystal source (kg/kg/s). Modified in place.</span>
<span class="sd">    rc_mf : Field[float]</span>
<span class="sd">        Cloud condensate from mass flux (kg/kg). Input field.</span>
<span class="sd">    ri_mf : Field[float]</span>
<span class="sd">        Ice condensate from mass flux (kg/kg). Input field.</span>
<span class="sd">    cf_mf : Field[float]</span>
<span class="sd">        Cloud fraction from mass flux (dimensionless, 0-1). Input field.</span>
<span class="sd">    cldfr : Field[float]</span>
<span class="sd">        Total cloud fraction (dimensionless, 0-1). Modified in place.</span>
<span class="sd">    hlc_hrc : Field[float]</span>
<span class="sd">        Liquid autoconversion amount (kg/kg). Modified in place.</span>
<span class="sd">    hlc_hcf : Field[float]</span>
<span class="sd">        Liquid autoconversion cloud fraction (dimensionless). Modified in place.</span>
<span class="sd">    hli_hri : Field[float]</span>
<span class="sd">        Ice autoconversion amount (kg/kg). Modified in place.</span>
<span class="sd">    hli_hcf : Field[float]</span>
<span class="sd">        Ice autoconversion cloud fraction (dimensionless). Modified in place.</span>
<span class="sd">    dt : float</span>
<span class="sd">        Physics time step (s). Scalar parameter.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Modifies cldfr, ths, rvs, rcs, ris, hlc_hrc, hlc_hcf, hli_hri, hli_hcf in place.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    **Two Operating Modes:**</span>

<span class="sd">    1. **Without Subgrid Condensation (LSUBG_COND=False):**</span>
<span class="sd">       - Binary cloud fraction: 0 or 1</span>
<span class="sd">       - Cloud present if (r_c + r_i) × Δt &gt; 10⁻¹²</span>
<span class="sd">       - Simple all-or-nothing approach</span>

<span class="sd">    2. **With Subgrid Condensation (LSUBG_COND=True, AROME default):**</span>
<span class="sd">       - Partial cloud fractions from mass flux scheme</span>
<span class="sd">       - Subgrid autoconversion using PDF methods</span>
<span class="sd">       - Accounts for sub-grid variability</span>

<span class="sd">    **Mass Flux Condensate Processing:**</span>

<span class="sd">    When LSUBG_COND is enabled:</span>

<span class="sd">    1. Convert mass flux condensate to rates:</span>
<span class="sd">       w₁ = rc_mf / Δt  (liquid rate, kg/kg/s)</span>
<span class="sd">       w₂ = ri_mf / Δt  (ice rate, kg/kg/s)</span>

<span class="sd">    2. Conservatively limit to available vapor:</span>
<span class="sd">       If w₁ + w₂ &gt; rv_s:</span>
<span class="sd">           w₁ → w₁ × rv_s/(w₁ + w₂)</span>
<span class="sd">           w₂ → rv_s - w₁</span>

<span class="sd">    3. Update cloud fraction additively:</span>
<span class="sd">       cf_total = min(1, cf_existing + cf_mf)</span>

<span class="sd">    4. Update mixing ratios and temperature</span>

<span class="sd">    **Subgrid Autoconversion:**</span>

<span class="sd">    Two PDF methods available via SUBG_MF_PDF:</span>

<span class="sd">    **Method 0 (NONE - Step Function):**</span>
<span class="sd">    - Autoconversion occurs if condensate exceeds threshold</span>
<span class="sd">    - Liquid: w₁×Δt &gt; cf_mf × (CRIAUTC/ρ)</span>
<span class="sd">    - Ice: w₂×Δt &gt; cf_mf × CRIAUTI(T)</span>
<span class="sd">    - All excess converts → rain/snow</span>
<span class="sd">    - Cloud fraction set to mass flux value</span>

<span class="sd">    **Method 1 (TRIANGLE - Triangular PDF):**</span>
<span class="sd">    - Assumes triangular sub-grid condensate distribution</span>
<span class="sd">    - Calculates partial autoconversion</span>
<span class="sd">    - More physical than step function</span>

<span class="sd">    For triangular PDF, three regimes:</span>

<span class="sd">    A. High condensate (q &gt; cf×r_crit):</span>
<span class="sd">       hcf = 1 - 0.5×(cf×r_crit/q)²</span>
<span class="sd">       hr = q - (cf×r_crit)³/(3q²)</span>
<span class="sd">       Large conversion, most of cloud converts</span>

<span class="sd">    B. Low condensate (q ≤ 0.5×cf×r_crit):</span>
<span class="sd">       hcf = 0, hr = 0</span>
<span class="sd">       No autoconversion</span>

<span class="sd">    C. Intermediate (0.5×cf×r_crit &lt; q ≤ cf×r_crit):</span>
<span class="sd">       hcf = (2q - cf×r_crit)²/(2q²)</span>
<span class="sd">       hr = [4q³ - 3q(cf×r_crit)² + (cf×r_crit)³]/(3q²)</span>
<span class="sd">       Partial conversion</span>

<span class="sd">    **Autoconversion Thresholds:**</span>

<span class="sd">    Liquid (cloud → rain):</span>
<span class="sd">    r_crit = CRIAUTC / ρ_ref</span>
<span class="sd">    Typical: ~5×10⁻⁴ kg/kg at surface</span>

<span class="sd">    Ice (ice → snow):</span>
<span class="sd">    r_crit(T) = min(CRIAUTI, 10^(A×(T-273.16) + B))</span>
<span class="sd">    Temperature-dependent, increases with warming</span>
<span class="sd">    Typical: ~2×10⁻⁵ kg/kg at -20°C</span>

<span class="sd">    **Physical Interpretation:**</span>

<span class="sd">    This stencil bridges the gap between:</span>
<span class="sd">    - Resolved-scale condensation (explicit grid-box saturation)</span>
<span class="sd">    - Unresolved shallow convection (mass flux parameterization)</span>
<span class="sd">    - Sub-grid variability (PDF-based autoconversion)</span>

<span class="sd">    It ensures smooth transition from small cumulus (mass flux)</span>
<span class="sd">    to stratiform clouds (resolved) by additive cloud fractions.</span>

<span class="sd">    **Diagnostic Outputs:**</span>

<span class="sd">    hlc_hrc, hlc_hcf: Liquid autoconversion amount and cloud fraction</span>
<span class="sd">    hli_hri, hli_hcf: Ice autoconversion amount and cloud fraction</span>

<span class="sd">    These are used later for:</span>
<span class="sd">    - Computing rain/snow production rates</span>
<span class="sd">    - Diagnosing precipitation initiation</span>
<span class="sd">    - Radiation calculations</span>

<span class="sd">    Source Reference</span>
<span class="sd">    ----------------</span>
<span class="sd">    PHYEX/src/common/micro/ice_adjust.F90, lines 313-419</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    thermodynamic_fields : Temperature and latent heat computation</span>
<span class="sd">    cloud_fraction_1 : Condensation source term computation</span>
<span class="sd">    condensation : Main condensation scheme with CB02</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Bougeault, P., 1981: Modeling the trade-wind cumulus boundary layer.</span>
<span class="sd">    Part I: Testing the ensemble cloud relations against numerical data.</span>
<span class="sd">    J. Atmos. Sci., 38, 2414-2428.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; # Binary cloud fraction mode (LSUBG_COND=False)</span>
<span class="sd">    &gt;&gt;&gt; # If total condensate &gt; threshold → cloud fraction = 1</span>
<span class="sd">    &gt;&gt;&gt; # Otherwise → cloud fraction = 0</span>

<span class="sd">    &gt;&gt;&gt; # PDF-based mode (LSUBG_COND=True, SUBG_MF_PDF=1)</span>
<span class="sd">    &gt;&gt;&gt; # Partial cloud fractions from mass flux</span>
<span class="sd">    &gt;&gt;&gt; # Subgrid autoconversion with triangular PDF</span>
<span class="sd">    &gt;&gt;&gt; # Smooth transitions, more realistic variability</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">__externals__</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">ACRIAUTI</span><span class="p">,</span>
        <span class="n">BCRIAUTI</span><span class="p">,</span>
        <span class="n">CRIAUTC</span><span class="p">,</span>
        <span class="n">CRIAUTI</span><span class="p">,</span>
        <span class="n">LSUBG_COND</span><span class="p">,</span>
        <span class="n">SUBG_MF_PDF</span><span class="p">,</span>
        <span class="n">TT</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 5.2  compute the cloud fraction cldfr</span>
    <span class="k">with</span> <span class="n">computation</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">),</span> <span class="n">interval</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">__INLINED</span><span class="p">(</span><span class="ow">not</span> <span class="n">LSUBG_COND</span><span class="p">):</span>
            <span class="n">cldfr</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="p">((</span><span class="n">rcs</span> <span class="o">+</span> <span class="n">ris</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mf">1e-12</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="c1"># Translation note : OCOMPUTE_SRC is taken False</span>
        <span class="c1"># Translation note : l320 to l322 removed</span>

        <span class="c1"># Translation note : LSUBG_COND = TRUE for Arome</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w1</span> <span class="o">=</span> <span class="n">rc_mf</span> <span class="o">/</span> <span class="n">dt</span>
            <span class="n">w2</span> <span class="o">=</span> <span class="n">ri_mf</span> <span class="o">/</span> <span class="n">dt</span>

            <span class="k">if</span> <span class="n">w1</span> <span class="o">+</span> <span class="n">w2</span> <span class="o">&gt;</span> <span class="n">rvs</span><span class="p">:</span>
                <span class="n">w1</span> <span class="o">*=</span> <span class="n">rvs</span> <span class="o">/</span> <span class="p">(</span><span class="n">w1</span> <span class="o">+</span> <span class="n">w2</span><span class="p">)</span>
                <span class="n">w2</span> <span class="o">=</span> <span class="n">rvs</span> <span class="o">-</span> <span class="n">w1</span>

            <span class="n">cldfr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cldfr</span> <span class="o">+</span> <span class="n">cf_mf</span><span class="p">)</span>
            <span class="n">rcs</span> <span class="o">+=</span> <span class="n">w1</span>
            <span class="n">ris</span> <span class="o">+=</span> <span class="n">w2</span>
            <span class="n">rvs</span> <span class="o">-=</span> <span class="n">w1</span> <span class="o">+</span> <span class="n">w2</span>
            <span class="n">ths</span> <span class="o">+=</span> <span class="p">(</span><span class="n">w1</span> <span class="o">*</span> <span class="n">lv</span> <span class="o">+</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">ls</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">cph</span> <span class="o">*</span> <span class="n">exnref</span><span class="p">)</span>

            <span class="c1"># Droplets subgrid autoconversion</span>
            <span class="c1"># LLHLC_H is True (AROME like) phlc_hrc and phlc_hcf are present</span>
            <span class="c1"># LLHLI_H is True (AROME like) phli_hri and phli_hcf are present</span>
            <span class="n">criaut</span> <span class="o">=</span> <span class="n">CRIAUTC</span> <span class="o">/</span> <span class="n">rhodref</span>

            <span class="c1"># ice_adjust.F90 IF LLNONE; IF CSUBG_MF_PDF is None</span>
            <span class="k">if</span> <span class="n">__INLINED</span><span class="p">(</span><span class="n">SUBG_MF_PDF</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="n">cf_mf</span> <span class="o">*</span> <span class="n">criaut</span><span class="p">:</span>
                    <span class="n">hlc_hrc</span> <span class="o">+=</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">dt</span>
                    <span class="n">hlc_hcf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">hlc_hcf</span> <span class="o">+</span> <span class="n">cf_mf</span><span class="p">)</span>

            <span class="c1"># Translation note : if LLTRIANGLE in .F90</span>
            <span class="k">if</span> <span class="n">__INLINED</span><span class="p">(</span><span class="n">SUBG_MF_PDF</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="n">cf_mf</span> <span class="o">*</span> <span class="n">criaut</span><span class="p">:</span>
                    <span class="n">hcf</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">criaut</span> <span class="o">*</span> <span class="n">cf_mf</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-20</span><span class="p">,</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">dt</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="n">hr</span> <span class="o">=</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">-</span> <span class="p">(</span><span class="n">criaut</span> <span class="o">*</span> <span class="n">cf_mf</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="p">(</span>
                        <span class="mi">3</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-20</span><span class="p">,</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="p">)</span>

                <span class="k">elif</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">&lt;=</span> <span class="n">cf_mf</span> <span class="o">*</span> <span class="n">criaut</span><span class="p">:</span>
                    <span class="n">hcf</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">hr</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hcf</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">-</span> <span class="n">criaut</span> <span class="o">*</span> <span class="n">cf_mf</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span>
                        <span class="mf">2.0</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.0e-20</span><span class="p">,</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="p">)</span>
                    <span class="n">hr</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="mf">4.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">w1</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span>
                        <span class="o">-</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">criaut</span> <span class="o">*</span> <span class="n">cf_mf</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="p">(</span><span class="n">criaut</span> <span class="o">*</span> <span class="n">cf_mf</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.0e-20</span><span class="p">,</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

                <span class="n">hcf</span> <span class="o">*=</span> <span class="n">cf_mf</span>
                <span class="n">hlc_hcf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">hlc_hcf</span> <span class="o">+</span> <span class="n">hcf</span><span class="p">)</span>
                <span class="n">hlc_hrc</span> <span class="o">+=</span> <span class="n">hr</span>

            <span class="c1"># Ice subgrid autoconversion</span>
            <span class="n">criaut</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="n">CRIAUTI</span><span class="p">,</span>
                <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">ACRIAUTI</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">TT</span><span class="p">)</span> <span class="o">+</span> <span class="n">BCRIAUTI</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># LLNONE in ice_adjust.F90</span>
            <span class="k">if</span> <span class="n">__INLINED</span><span class="p">(</span><span class="n">SUBG_MF_PDF</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="n">cf_mf</span> <span class="o">*</span> <span class="n">criaut</span><span class="p">:</span>
                    <span class="n">hli_hri</span> <span class="o">+=</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">dt</span>
                    <span class="n">hli_hcf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">hli_hcf</span> <span class="o">+</span> <span class="n">cf_mf</span><span class="p">)</span>

            <span class="c1"># LLTRIANGLE in ice_adjust.F90</span>
            <span class="k">if</span> <span class="n">__INLINED</span><span class="p">(</span><span class="n">SUBG_MF_PDF</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="n">cf_mf</span> <span class="o">*</span> <span class="n">criaut</span><span class="p">:</span>
                    <span class="n">hcf</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">criaut</span> <span class="o">*</span> <span class="n">cf_mf</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">w2</span> <span class="o">*</span> <span class="n">dt</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="n">hri</span> <span class="o">=</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">-</span> <span class="p">(</span><span class="n">criaut</span> <span class="o">*</span> <span class="n">cf_mf</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">w2</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

                <span class="k">elif</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">&lt;=</span> <span class="n">cf_mf</span> <span class="o">*</span> <span class="n">criaut</span><span class="p">:</span>
                    <span class="n">hcf</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">hri</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hcf</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">-</span> <span class="n">criaut</span> <span class="o">*</span> <span class="n">cf_mf</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">w2</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">hri</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="mf">4.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">w2</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span>
                        <span class="o">-</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">criaut</span> <span class="o">*</span> <span class="n">cf_mf</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="p">(</span><span class="n">criaut</span> <span class="o">*</span> <span class="n">cf_mf</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">w2</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

                <span class="n">hcf</span> <span class="o">*=</span> <span class="n">cf_mf</span>
                <span class="n">hli_hcf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">hli_hcf</span> <span class="o">+</span> <span class="n">hcf</span><span class="p">)</span>
                <span class="n">hli_hri</span> <span class="o">+=</span> <span class="n">hri</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ice3.stencils.cloud_fraction.thermodynamic_fields" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">thermodynamic_fields</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="n">exn</span><span class="p">,</span> <span class="n">rv</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">rg</span><span class="p">,</span> <span class="n">lv</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">cph</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Compute temperature, latent heats, and moist air specific heat.</p>
<p>This stencil computes fundamental thermodynamic fields needed for
saturation adjustment and cloud fraction calculations. It converts
potential temperature to actual temperature, calculates temperature-
dependent latent heats, and computes the specific heat of moist air
including all hydrometeor species.</p>
<h4 id="ice3.stencils.cloud_fraction.thermodynamic_fields--parameters">Parameters</h4>
<p>th : Field[float]
    Potential temperature (K). Input field.
exn : Field[float]
    Exner function π = (p/p₀)^(R_d/c_pd) (dimensionless). Input field.
rv : Field[float]
    Water vapor mixing ratio (kg/kg). Input field.
rc : Field[float]
    Cloud droplet mixing ratio (kg/kg). Input field.
rr : Field[float]
    Rain mixing ratio (kg/kg). Input field.
ri : Field[float]
    Ice crystal mixing ratio (kg/kg). Input field.
rs : Field[float]
    Snow mixing ratio (kg/kg). Input field.
rg : Field[float]
    Graupel mixing ratio (kg/kg). Input field.
lv : Field[float]
    Latent heat of vaporization (J/kg). Output field.
ls : Field[float]
    Latent heat of sublimation (J/kg). Output field.
cph : Field[float]
    Specific heat of moist air at constant pressure (J/(kg·K)). Output field.
t : Field[float]
    Actual temperature (K). Output field.</p>
<h4 id="ice3.stencils.cloud_fraction.thermodynamic_fields--returns">Returns</h4>
<p>None
    Modifies lv, ls, cph, and t in place.</p>
<h4 id="ice3.stencils.cloud_fraction.thermodynamic_fields--notes">Notes</h4>
<p><strong>Temperature Calculation:</strong></p>
<p>T = θ × π</p>
<p>where θ is potential temperature and π is the Exner function.</p>
<p><strong>Latent Heats (Temperature Dependent):</strong></p>
<p>The latent heats vary with temperature to account for the temperature
dependence of specific heats:</p>
<ul>
<li>L_v(T): Vaporization latent heat (liquid → vapor)</li>
<li>L_s(T): Sublimation latent heat (ice → vapor)</li>
<li>L_m(T) = L_s(T) - L_v(T): Melting latent heat (ice → liquid)</li>
</ul>
<p><strong>Moist Air Specific Heat:</strong></p>
<p>c_ph = c_pd + c_pv×r_v + c_l×(r_c + r_r) + c_i×(r_i + r_s + r_g)</p>
<p>Includes contributions from:
- Dry air (c_pd)
- Water vapor (c_pv × r_v)
- Liquid water (c_l × (r_c + r_r))
- Ice (c_i × (r_i + r_s + r_g))</p>
<p>The specific heat is used in temperature tendency calculations when
phase changes occur: dT/dt = L_x × (dr_x/dt) / c_ph</p>
<p><strong>Hydrometeor Categories (NRR):</strong></p>
<ul>
<li>NRR=2: Cloud + Ice (minimal scheme)</li>
<li>NRR=4: Cloud + Rain (warm rain only)</li>
<li>NRR=5: Cloud + Rain + Ice + Snow (no graupel)</li>
<li>NRR=6: Cloud + Rain + Ice + Snow + Graupel (full ICE3)</li>
<li>NRR=7: Full ICE4 with hail (not implemented in GT4Py version)</li>
</ul>
<h4 id="ice3.stencils.cloud_fraction.thermodynamic_fields--source-reference">Source Reference</h4>
<p>PHYEX/src/common/micro/ice_adjust.F90, lines 450-473</p>
<h4 id="ice3.stencils.cloud_fraction.thermodynamic_fields--see-also">See Also</h4>
<p>cloud_fraction_1 : Cloud fraction computation after condensation
cloud_fraction_2 : Subgrid autoconversion in cloud fraction</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/ice3/stencils/cloud_fraction.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">thermodynamic_fields</span><span class="p">(</span>
    <span class="n">th</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">exn</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">rv</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">rc</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">rr</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">ri</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">rs</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">rg</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">lv</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">ls</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">cph</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">Field</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute temperature, latent heats, and moist air specific heat.</span>

<span class="sd">    This stencil computes fundamental thermodynamic fields needed for</span>
<span class="sd">    saturation adjustment and cloud fraction calculations. It converts</span>
<span class="sd">    potential temperature to actual temperature, calculates temperature-</span>
<span class="sd">    dependent latent heats, and computes the specific heat of moist air</span>
<span class="sd">    including all hydrometeor species.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    th : Field[float]</span>
<span class="sd">        Potential temperature (K). Input field.</span>
<span class="sd">    exn : Field[float]</span>
<span class="sd">        Exner function π = (p/p₀)^(R_d/c_pd) (dimensionless). Input field.</span>
<span class="sd">    rv : Field[float]</span>
<span class="sd">        Water vapor mixing ratio (kg/kg). Input field.</span>
<span class="sd">    rc : Field[float]</span>
<span class="sd">        Cloud droplet mixing ratio (kg/kg). Input field.</span>
<span class="sd">    rr : Field[float]</span>
<span class="sd">        Rain mixing ratio (kg/kg). Input field.</span>
<span class="sd">    ri : Field[float]</span>
<span class="sd">        Ice crystal mixing ratio (kg/kg). Input field.</span>
<span class="sd">    rs : Field[float]</span>
<span class="sd">        Snow mixing ratio (kg/kg). Input field.</span>
<span class="sd">    rg : Field[float]</span>
<span class="sd">        Graupel mixing ratio (kg/kg). Input field.</span>
<span class="sd">    lv : Field[float]</span>
<span class="sd">        Latent heat of vaporization (J/kg). Output field.</span>
<span class="sd">    ls : Field[float]</span>
<span class="sd">        Latent heat of sublimation (J/kg). Output field.</span>
<span class="sd">    cph : Field[float]</span>
<span class="sd">        Specific heat of moist air at constant pressure (J/(kg·K)). Output field.</span>
<span class="sd">    t : Field[float]</span>
<span class="sd">        Actual temperature (K). Output field.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Modifies lv, ls, cph, and t in place.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    **Temperature Calculation:**</span>

<span class="sd">    T = θ × π</span>

<span class="sd">    where θ is potential temperature and π is the Exner function.</span>

<span class="sd">    **Latent Heats (Temperature Dependent):**</span>

<span class="sd">    The latent heats vary with temperature to account for the temperature</span>
<span class="sd">    dependence of specific heats:</span>

<span class="sd">    - L_v(T): Vaporization latent heat (liquid → vapor)</span>
<span class="sd">    - L_s(T): Sublimation latent heat (ice → vapor)</span>
<span class="sd">    - L_m(T) = L_s(T) - L_v(T): Melting latent heat (ice → liquid)</span>

<span class="sd">    **Moist Air Specific Heat:**</span>

<span class="sd">    c_ph = c_pd + c_pv×r_v + c_l×(r_c + r_r) + c_i×(r_i + r_s + r_g)</span>

<span class="sd">    Includes contributions from:</span>
<span class="sd">    - Dry air (c_pd)</span>
<span class="sd">    - Water vapor (c_pv × r_v)</span>
<span class="sd">    - Liquid water (c_l × (r_c + r_r))</span>
<span class="sd">    - Ice (c_i × (r_i + r_s + r_g))</span>

<span class="sd">    The specific heat is used in temperature tendency calculations when</span>
<span class="sd">    phase changes occur: dT/dt = L_x × (dr_x/dt) / c_ph</span>

<span class="sd">    **Hydrometeor Categories (NRR):**</span>

<span class="sd">    - NRR=2: Cloud + Ice (minimal scheme)</span>
<span class="sd">    - NRR=4: Cloud + Rain (warm rain only)</span>
<span class="sd">    - NRR=5: Cloud + Rain + Ice + Snow (no graupel)</span>
<span class="sd">    - NRR=6: Cloud + Rain + Ice + Snow + Graupel (full ICE3)</span>
<span class="sd">    - NRR=7: Full ICE4 with hail (not implemented in GT4Py version)</span>

<span class="sd">    Source Reference</span>
<span class="sd">    ----------------</span>
<span class="sd">    PHYEX/src/common/micro/ice_adjust.F90, lines 450-473</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    cloud_fraction_1 : Cloud fraction computation after condensation</span>
<span class="sd">    cloud_fraction_2 : Subgrid autoconversion in cloud fraction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">__externals__</span><span class="w"> </span><span class="kn">import</span> <span class="n">CI</span><span class="p">,</span> <span class="n">CL</span><span class="p">,</span> <span class="n">CPD</span><span class="p">,</span> <span class="n">CPV</span><span class="p">,</span> <span class="n">NRR</span>

    <span class="c1"># 2.3 Compute the variation of mixing ratio</span>
    <span class="k">with</span> <span class="n">computation</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">),</span> <span class="n">interval</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">th</span> <span class="o">*</span> <span class="n">exn</span>
        <span class="n">lv</span> <span class="o">=</span> <span class="n">vaporisation_latent_heat</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">sublimation_latent_heat</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># Translation note : in Fortran, ITERMAX = 1, DO JITER =1,ITERMAX</span>
    <span class="c1"># Translation note : version without iteration is kept (1 iteration)</span>
    <span class="c1">#                   IF jiter = 1; CALL ITERATION()</span>
    <span class="c1"># jiter &gt; 0</span>

    <span class="c1"># numer of moist variables fixed to 6 (without hail)</span>

    <span class="c1"># Translation note :</span>
    <span class="c1"># 2.4 specific heat for moist air at t+1</span>
    <span class="k">with</span> <span class="n">computation</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">),</span> <span class="n">interval</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="c1"># Translation note : case(7) removed because hail is not taken into account</span>
        <span class="c1"># Translation note : l453 to l456 removed</span>
        <span class="k">if</span> <span class="n">__INLINED</span><span class="p">(</span><span class="n">NRR</span> <span class="o">==</span> <span class="mi">6</span><span class="p">):</span>
            <span class="n">cph</span> <span class="o">=</span> <span class="n">CPD</span> <span class="o">+</span> <span class="n">CPV</span> <span class="o">*</span> <span class="n">rv</span> <span class="o">+</span> <span class="n">CL</span> <span class="o">*</span> <span class="p">(</span><span class="n">rc</span> <span class="o">+</span> <span class="n">rr</span><span class="p">)</span> <span class="o">+</span> <span class="n">CI</span> <span class="o">*</span> <span class="p">(</span><span class="n">ri</span> <span class="o">+</span> <span class="n">rs</span> <span class="o">+</span> <span class="n">rg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">__INLINED</span><span class="p">(</span><span class="n">NRR</span> <span class="o">==</span> <span class="mi">5</span><span class="p">):</span>
            <span class="n">cph</span> <span class="o">=</span> <span class="n">CPD</span> <span class="o">+</span> <span class="n">CPV</span> <span class="o">*</span> <span class="n">rv</span> <span class="o">+</span> <span class="n">CL</span> <span class="o">*</span> <span class="p">(</span><span class="n">rc</span> <span class="o">+</span> <span class="n">rr</span><span class="p">)</span> <span class="o">+</span> <span class="n">CI</span> <span class="o">*</span> <span class="p">(</span><span class="n">ri</span> <span class="o">+</span> <span class="n">rs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">__INLINED</span><span class="p">(</span><span class="n">NRR</span> <span class="o">==</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">cph</span> <span class="o">=</span> <span class="n">CPD</span> <span class="o">+</span> <span class="n">CPV</span> <span class="o">*</span> <span class="n">rv</span> <span class="o">+</span> <span class="n">CL</span> <span class="o">*</span> <span class="p">(</span><span class="n">rc</span> <span class="o">+</span> <span class="n">rr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">__INLINED</span><span class="p">(</span><span class="n">NRR</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">cph</span> <span class="o">=</span> <span class="n">CPD</span> <span class="o">+</span> <span class="n">CPV</span> <span class="o">*</span> <span class="n">rv</span> <span class="o">+</span> <span class="n">CL</span> <span class="o">*</span> <span class="n">rc</span> <span class="o">+</span> <span class="n">CI</span> <span class="o">*</span> <span class="n">ri</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../ice_adjust/" class="btn btn-neutral float-left" title="Ice adjust"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../condensation/" class="btn btn-neutral float-right" title="Condensation">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../ice_adjust/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../condensation/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
