name: HPC Build & Publish

on:
  push:
    branches: [ "reorg" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-convert:
    runs-on: self-hosted # Votre runner privé
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Stratégie de matrice pour paralléliser ou clarifier les builds
      - name: Build and Push Docker Images
        id: docker_build
        run: |
          # JAX CPU/GPU
          docker build --target target-jax -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:jax-latest .
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:jax-latest
          
          # OpenACC
          docker build --target target-acc -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:acc-latest .
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:acc-latest
          
          # Cython (si distinct)
          # docker build --target runtime-cython -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cython-latest .
          # docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cython-latest

      - name: Convert to Singularity (.sif)
        id: singularity_build
        run: |
          mkdir -p build_artifacts
          
          echo "Conversion JAX..."
          # Note: Sur le self-hosted, on peut taper directement dans le daemon Docker local
          # Attention aux permissions sudo selon la config du runner
          singularity build --force build_artifacts/dwarf_jax.sif docker-daemon://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:jax-latest
          
          echo "Conversion OpenACC..."
          singularity build --force build_artifacts/dwarf_acc.sif docker-daemon://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:acc-latest

      - name: Upload SIF Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hpc-singularity-images
          path: build_artifacts/*.sif
          retention-days: 5